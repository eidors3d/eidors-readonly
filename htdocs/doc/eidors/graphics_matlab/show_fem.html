<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of show_fem</title>
  <meta name="keywords" content="show_fem">
  <meta name="description" content="SHOW_FEM: show the EIDORS3D finite element model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html?eidors/graphics_matlab/show_fem.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html eidors --><!-- menu.html graphics_matlab -->
<h1>show_fem
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>SHOW_FEM: show the EIDORS3D finite element model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function hh=show_fem( mdl, options) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> SHOW_FEM: show the EIDORS3D finite element model
 hh=show_fem( mdl, options )
 mdl is a EIDORS3D 'model' or 'image' structure
 hh= handle to the plotted model

 options specifies a set of options
   options(1) =&gt; show colourbar
   options(2) =&gt; show numbering on electrodes
   options(3) =&gt; number elements (==1) or nodes (==2);

 for detailed control of colours, use
    img.calc_colours.&quot;parameter&quot; = value
 see help for calc_colours.

 for control of colourbar, use img.calc_colours.cb_shrink_move

 to change colours, try hh=show_fem(...); set(hh,'EdgeColor',[0,0,1];</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/algorithms/a_adler/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>	INTERP_MESH: calculate interpolation points onto mdl elements</li><li><a href="../../eidors/algorithms/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>	CALC_JACOBIAN_BKGND: calculate background image around</li><li><a href="../../eidors/algorithms/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>	GET_IMG_DATA: get parameter data from eidors image object</li><li><a href="../../eidors/algorithms/n_polydorides/find_boundary.html" class="code" title="function [srf, idx] = find_boundary(simp);">find_boundary</a>	[srf, idx] = find_boundary(simp);</li><li><a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG: eidors progress and status messages</li><li><a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>	[colours,scl_data]= calc_colours(img, set_value, do_colourbar)</li><li><a href="repaint_inho.html" class="code" title="function repaint_inho(mat,mat_ref,vtx,simp, thresh, clr_def);">repaint_inho</a>	function repaint_inho(mat,mat_ref,vtx,simp, thresh);</li><li><a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>	SHOW_FEM: show the EIDORS3D finite element model</li><li><a href="../../eidors/models/a_adler/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>	MDL_DIM: dimension of model space (are nodes in 2D or 3D space)</li><li><a href="../../eidors/models/a_adler/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/algorithms/a_adler/mk_c2f_circ_mapping.html" class="code" title="function [mapping failed] = mk_c2f_circ_mapping( mdl, xyzr );">mk_c2f_circ_mapping</a>	MK_C2F_CIRC_MAPPING: create a mapping matrix from circles/spheres to FEM</li><li><a href="../../eidors/examples/cheating_2d.html" class="code" title="function out=cheating_2d( figno, rand_seed )">cheating_2d</a>	code to simulate inverse crimes in EIT</li><li><a href="../../eidors/examples/demo_2d_simdata.html" class="code" title="">demo_2d_simdata</a>	Example of using EIDORS to simulate 2D data and to</li><li><a href="../../eidors/examples/demo_3d_simdata.html" class="code" title="">demo_3d_simdata</a>	How to make simulation data using EIDORS3D</li><li><a href="../../eidors/examples/demo_real.html" class="code" title="function [inhomg_img, demo_img] = demo_real;">demo_real</a>	[inhomg_img, demo_img] = demo_real;</li><li><a href="../../eidors/examples/eidors2d_demo1.html" class="code" title="">eidors2d_demo1</a>	EidorsDemo1 Demonstrates the use of 2D EIT Package with linear basis</li><li><a href="../../eidors/examples/image_2d_algs.html" class="code" title="">image_2d_algs</a>	Based on the 'bubble' data from Eidors2D, use several</li><li><a href="../../eidors/examples/manchester_tomography.html" class="code" title="function manchester_tomography( example_no)">manchester_tomography</a>	Example to show reconstructions from</li><li><a href="../../eidors/examples/object_in_tank_2d.html" class="code" title="">object_in_tank_2d</a>	2D demo example for reconstruction of object floating inside tank with</li><li><a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>	SHOW_FEM: show the EIDORS3D finite element model</li><li><a href="show_fem_move.html" class="code" title="function show_fem_move( img, move, scale, options )">show_fem_move</a>	SHOW_FEM_MOVE   Plot EIT finite element model (FEM) and movement</li><li><a href="../../eidors/meshing/distmesh/dm_2d_circ_pt_elecs.html" class="code" title="function fmdl = dm_2d_circ_pt_elecs( elec_pts, pfix, spacing);">dm_2d_circ_pt_elecs</a>	DM_2D_CIRC_PT_ELECS: Create circle mesh (or radius 1) refined with electrodes</li><li><a href="../../eidors/meshing/netgen/ng_mk_extruded_model.html" class="code" title="function [fmdl,mat_idx] = ng_mk_extruded_model(shape, elec_pos, elec_shape,extra_ng_code)">ng_mk_extruded_model</a>	NG_MAKE_EXTRUDED_MODEL: create extruded models using netgen</li><li><a href="../../eidors/meshing/netgen/ng_mk_gen_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_gen_models(shape_str, elec_pos,  elec_shape, elec_obj);">ng_mk_gen_models</a>	NG_MAKE_ELLIP_MODELS: create elliptical models using netgen</li><li><a href="../../eidors/models/a_adler/deform_cylinder.html" class="code" title="function fwd_mdl = deform_cylinder( fwd_mdl, geo);">deform_cylinder</a>	fwd_mdl = deform_cylinder( fwd_mdl, niv);</li><li><a href="../../eidors/models/a_adler/mk_GREIT_model.html" class="code" title="function [imdl, weight]= mk_GREIT_model( fmdl, radius, weight, options )">mk_GREIT_model</a>	MK_GREIT_MODEL: make EIDORS inverse models using the GREIT approach</li><li><a href="../../eidors/models/a_adler/test_GREIT_model.html" class="code" title="">test_GREIT_model</a>	</li><li><a href="../../eidors/models/b_grychtol/mk_library_model.html" class="code" title="function out = mk_library_model(shape,elec_pos,elec_shape,maxsz,nfft)">mk_library_model</a>	MK_LIBRARY_MODEL - FEM models based on library shapes</li><li><a href="../../eidors/tests/test_2d_resistor.html" class="code" title="">test_2d_resistor</a>	Create 2D model of a cylindrical resistor</li><li><a href="../../eidors/tests/test_3d_resistor.html" class="code" title="">test_3d_resistor</a>	Create 3D model of a Rectangular resistor</li><li><a href="../../eidors/tests/test_colour_direction.html" class="code" title="">test_colour_direction</a>	Test colour mapping</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [img,mdl,opts] = proc_params( mdl, options );</a></li><li><a href="#_sub2" class="code">function hh= show_2d(img,mdl,opts)</a></li><li><a href="#_sub3" class="code">function hh= show_3d(img,mdl,opts)</a></li><li><a href="#_sub4" class="code">function show_electrodes_2d(mdl, number_electrodes)</a></li><li><a href="#_sub5" class="code">function show_electrodes_3d(mdl, number_electrodes);</a></li><li><a href="#_sub6" class="code">function show_inhomogeneities( elem_data, mdl, img)</a></li><li><a href="#_sub7" class="code">function paint_electrodes(sel,srf,vtx, colour, show_num);</a></li><li><a href="#_sub8" class="code">function hh= show_3d_fem( mdl, options )</a></li><li><a href="#_sub9" class="code">function hh=show_2d_fem( mdl, colours, imgno )</a></li><li><a href="#_sub10" class="code">function old_code_3d_plot</a></li><li><a href="#_sub11" class="code">function plot_2d_mesh(NODE,ELEM,el_pos, S, options)</a></li><li><a href="#_sub12" class="code">function  mes= avg_electrode_posn( mdl )</a></li><li><a href="#_sub13" class="code">function colour= electr_colour( e);</a></li><li><a href="#_sub14" class="code">function ee= get_boundary( mdl )</a></li><li><a href="#_sub15" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function hh=show_fem( mdl, options)</a>
0002 <span class="comment">% SHOW_FEM: show the EIDORS3D finite element model</span>
0003 <span class="comment">% hh=show_fem( mdl, options )</span>
0004 <span class="comment">% mdl is a EIDORS3D 'model' or 'image' structure</span>
0005 <span class="comment">% hh= handle to the plotted model</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% options specifies a set of options</span>
0008 <span class="comment">%   options(1) =&gt; show colourbar</span>
0009 <span class="comment">%   options(2) =&gt; show numbering on electrodes</span>
0010 <span class="comment">%   options(3) =&gt; number elements (==1) or nodes (==2);</span>
0011 <span class="comment">%</span>
0012 <span class="comment">% for detailed control of colours, use</span>
0013 <span class="comment">%    img.calc_colours.&quot;parameter&quot; = value</span>
0014 <span class="comment">% see help for calc_colours.</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% for control of colourbar, use img.calc_colours.cb_shrink_move</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% to change colours, try hh=show_fem(...); set(hh,'EdgeColor',[0,0,1];</span>
0019 
0020 <span class="comment">% (C) 2005-2011 Andy Adler. License: GPL version 2 or version 3</span>
0021 <span class="comment">% $Id$</span>
0022 
0023 <span class="comment">% TESTS</span>
0024 <span class="keyword">switch</span> nargin
0025    <span class="keyword">case</span> 0;
0026      error(<span class="string">'Insufficient parameters for show_fem'</span>);
0027    <span class="keyword">case</span> 1;
0028      <span class="keyword">if</span> isstr(mdl) &amp;&amp; strcmp(mdl,<span class="string">'UNIT_TEST'</span>); <a href="#_sub15" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0029      options = [];
0030 <span class="keyword">end</span>
0031 [img,mdl,opts] = <a href="#_sub1" class="code" title="subfunction [img,mdl,opts] = proc_params( mdl, options );">proc_params</a>( mdl, options );
0032 
0033 <span class="keyword">if</span> ~ishold
0034     cla;
0035 <span class="keyword">end</span>
0036 
0037 
0038 <span class="keyword">switch</span> opts.dims
0039    <span class="keyword">case</span> 2;    hh= <a href="#_sub2" class="code" title="subfunction hh= show_2d(img,mdl,opts)">show_2d</a>(img,mdl,opts);
0040    <span class="keyword">case</span> 3;    hh= <a href="#_sub3" class="code" title="subfunction hh= show_3d(img,mdl,opts)">show_3d</a>(img,mdl,opts);
0041    <span class="keyword">otherwise</span>; error(<span class="string">'model is not 2D or 3D'</span>);
0042 <span class="keyword">end</span>
0043 
0044 <span class="keyword">if</span> opts.show_numbering
0045    <span class="keyword">if</span>     bitand( opts.show_numbering, 1 )
0046       xyzc= <a href="../../eidors/algorithms/a_adler/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>(mdl);
0047    <span class="keyword">elseif</span> bitand( opts.show_numbering, 2 )
0048       xyzc= mdl.nodes;
0049    <span class="keyword">else</span>
0050       error(<span class="string">'don''t understand show_numbering value of %d'</span>, opts.show_numbering);
0051    <span class="keyword">end</span>
0052    xyzc= xyzc * eye(size(xyzc,2),3); <span class="comment">%convert to 3D</span>
0053    <span class="keyword">for</span> i= 1:size(xyzc,1)
0054       text(xyzc(i,1),xyzc(i,2), xyzc(i,3), num2str(i), <span class="keyword">...</span>
0055             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>,<span class="string">'FontSize'</span>,7);
0056    <span class="keyword">end</span>
0057 <span class="keyword">end</span>
0058 
0059 <span class="keyword">if</span> nargout == 0; clear hh; <span class="keyword">end</span>
0060 
0061 
0062 <a name="_sub1" href="#_subfunctions" class="code">function [img,mdl,opts] = proc_params( mdl, options );</a>
0063 
0064    opts.do_colourbar=0;
0065    opts.number_electrodes=0;
0066    opts.show_numbering  =0;
0067    <span class="keyword">if</span> nargin &gt;=2
0068        <span class="comment">% fill in default options</span>
0069        optionstr= zeros(1,100);
0070        optionstr(1:length(options)) = options;
0071 
0072        opts.do_colourbar=      optionstr(1);
0073        opts.number_electrodes= optionstr(2);
0074        opts.show_numbering   =  optionstr(3);
0075    <span class="keyword">end</span>
0076 
0077    <span class="comment">% if we have an only img input, then define mdl</span>
0078    <span class="keyword">if</span> strcmp( mdl(1).type , <span class="string">'image'</span> )
0079       img= mdl;
0080       mdl= img.fwd_model;
0081    <span class="keyword">else</span> 
0082       img = [];
0083    <span class="keyword">end</span>
0084 
0085    opts.dims = size(mdl.nodes,2);
0086 
0087 <span class="comment">% 2D Case</span>
0088 <a name="_sub2" href="#_subfunctions" class="code">function hh= show_2d(img,mdl,opts)</a>
0089    hax= gca;
0090    pax= get(hax,<span class="string">'position'</span>);
0091    <span class="keyword">if</span> ~isempty(img)
0092       colours= <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img, [] );
0093    <span class="keyword">else</span>
0094       colours= [1,1,1]; <span class="comment">% white elements if no image</span>
0095    <span class="keyword">end</span>
0096    hh= <a href="#_sub9" class="code" title="subfunction hh=show_2d_fem( mdl, colours, imgno )">show_2d_fem</a>( mdl, colours );
0097    <a href="#_sub4" class="code" title="subfunction show_electrodes_2d(mdl, number_electrodes)">show_electrodes_2d</a>(mdl, opts.number_electrodes);
0098 
0099    set(hax,<span class="string">'position'</span>, pax);
0100    view(0, 90); axis(<span class="string">'xy'</span>); grid(<span class="string">'off'</span>);
0101 
0102 <span class="comment">% IN MATLAB 7 WE NEED TO RERUN THIS BECAUSE STUPID STUPID</span>
0103 <span class="comment">% MATLAB WILL RESET THE COLOURBAR EVERY TIME WE RUN PATCH!!!</span>
0104    <span class="keyword">if</span> exist(<span class="string">'img'</span>,<span class="string">'var'</span>) &amp;&amp; opts.do_colourbar;
0105       colours= <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img, [], opts.do_colourbar);
0106       <span class="comment">% Matlab is so weird. It puts the first colorbar in the wrong place</span>
0107       <span class="comment">%   sometimes ...  (tested with 6.5 and with 7.8)</span>
0108       <span class="comment">%   The trick is to never try to move it on the first go</span>
0109       <span class="comment">%   OR we reset it and then replace it. STUPID STUPID</span>
0110 
0111      <span class="comment">% Here's the magic trick I found. Force a drawnow,</span>
0112      <span class="comment">%     then delete and recreate</span>
0113       <span class="keyword">if</span> ~exist(<span class="string">'OCTAVE_VERSION'</span>)
0114          drawnow; colorbar(<span class="string">'delete'</span>);
0115          colours= <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img, [], opts.do_colourbar);
0116       <span class="keyword">end</span>
0117    <span class="keyword">end</span>
0118 
0119    
0120 
0121 <span class="comment">% 3D Case</span>
0122 <a name="_sub3" href="#_subfunctions" class="code">function hh= show_3d(img,mdl,opts)</a>
0123    hh= <a href="#_sub8" class="code" title="subfunction hh= show_3d_fem( mdl, options )">show_3d_fem</a>( mdl );
0124 
0125    <span class="keyword">if</span> ~isempty(img)
0126        elem_data = <a href="../../eidors/algorithms/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>(img);
0127        <a href="#_sub6" class="code" title="subfunction show_inhomogeneities( elem_data, mdl, img)">show_inhomogeneities</a>( elem_data , mdl, img);
0128        <span class="keyword">if</span> opts.do_colourbar
0129            <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img, [], opts.do_colourbar);
0130        <span class="keyword">end</span>
0131    <span class="keyword">end</span>
0132 
0133    <a href="#_sub5" class="code" title="subfunction show_electrodes_3d(mdl, number_electrodes);">show_electrodes_3d</a>(mdl, opts.number_electrodes);
0134 
0135 <a name="_sub4" href="#_subfunctions" class="code">function show_electrodes_2d(mdl, number_electrodes)</a>
0136     <span class="keyword">if</span> ~isfield(mdl,<span class="string">'electrode'</span>); <span class="keyword">return</span>; <span class="keyword">end</span>
0137 
0138     ee= <a href="#_sub14" class="code" title="subfunction ee= get_boundary( mdl )">get_boundary</a>( mdl );
0139     ctr_x= mean(mdl.nodes(:,1));
0140     ctr_y= mean(mdl.nodes(:,2));
0141 
0142 <span class="comment">% scale away from model</span>
0143 
0144 <span class="keyword">for</span> e=1:length(mdl.electrode)
0145     elec_nodes= mdl.electrode(e).nodes;
0146 
0147     S= 1.00;
0148     vx= (mdl.nodes(elec_nodes,1) - ctr_x)*S;
0149     vy= (mdl.nodes(elec_nodes,2) - ctr_y)*S;
0150     <span class="comment">% sort nodes around the model (to avoid crossed lines)</span>
0151     [jnk,idx] = sort(unwrap(atan2( vy, vx )));
0152     ecolour = <a href="#_sub13" class="code" title="subfunction colour= electr_colour( e);">electr_colour</a>( e );
0153     <span class="keyword">if</span>(length(elec_nodes) == 1)
0154        <span class="comment">% Point Electrode Models: put a circle around the node</span>
0155        line(vx(idx)+ctr_x,vy(idx)+ctr_y,  <span class="keyword">...</span>
0156             <span class="string">'LineWidth'</span>, 2, <span class="string">'LineStyle'</span>,<span class="string">'-'</span>,<span class="string">'Color'</span>, ecolour, <span class="keyword">...</span>
0157             <span class="string">'Marker'</span>,<span class="string">'o'</span>,<span class="string">'MarkerSize'</span>, 6,<span class="string">'MarkerEdgeColor'</span>,ecolour);
0158     <span class="keyword">else</span>
0159        <span class="comment">% Complete/Shunt Electrode Models (multiple nodes per electrode)</span>
0160        <span class="comment">%  put a line along the edges that form the electrode</span>
0161        line(vx(idx)+ctr_x,vy(idx)+ctr_y,  <span class="keyword">...</span>
0162             <span class="string">'LineWidth'</span>, 3, <span class="string">'LineStyle'</span>,<span class="string">'-'</span>,<span class="string">'Color'</span>, ecolour, <span class="keyword">...</span>
0163             <span class="string">'Marker'</span>,<span class="string">'none'</span>,<span class="string">'MarkerSize'</span>, 6,<span class="string">'MarkerEdgeColor'</span>,ecolour);
0164     <span class="keyword">end</span>
0165     <span class="keyword">if</span> number_electrodes
0166        S= 1.05;
0167        vx= (mdl.nodes(elec_nodes,1) - ctr_x)*S;
0168        vy= (mdl.nodes(elec_nodes,2) - ctr_y)*S;
0169        hh= text(mean(vx), mean(vy), num2str(e));
0170        set(hh, <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
0171     <span class="keyword">end</span>
0172 <span class="keyword">end</span>
0173 
0174 <a name="_sub5" href="#_subfunctions" class="code">function show_electrodes_3d(mdl, number_electrodes);</a>
0175 <span class="comment">% show electrode positions on model</span>
0176 <span class="keyword">if</span> ~isfield(mdl,<span class="string">'electrode'</span>); <span class="keyword">return</span>; <span class="keyword">end</span>
0177 
0178 ee= <a href="#_sub14" class="code" title="subfunction ee= get_boundary( mdl )">get_boundary</a>( mdl );
0179 <span class="keyword">for</span> e=1:length(mdl.electrode)
0180     elec_nodes= mdl.electrode(e).nodes;
0181 
0182     colour= <a href="#_sub13" class="code" title="subfunction colour= electr_colour( e);">electr_colour</a>( e);
0183 
0184     <span class="keyword">if</span> length(elec_nodes) == 1  <span class="comment">% point electrode model</span>
0185         vtx= mdl.nodes(elec_nodes,:);
0186         line(vtx(1),vtx(2),vtx(3), <span class="keyword">...</span>
0187             <span class="string">'Marker'</span>,<span class="string">'o'</span>,<span class="string">'MarkerSize'</span>,12, <span class="keyword">...</span>
0188             <span class="string">'MarkerFaceColor'</span>,colour, <span class="string">'MarkerEdgeColor'</span>, colour);
0189         <span class="keyword">if</span> number_electrodes
0190             hh= text(vtx(1),vtx(2),vtx(3), num2str(e));
0191             set(hh, <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
0192         <span class="keyword">end</span>
0193     <span class="keyword">else</span>
0194         <span class="comment">% find elems on boundary attached to this electrode</span>
0195         nn=ones(size(ee,1),1)*mdl.electrode(e).nodes(:)';
0196         oo=ones(1,size(nn,2));
0197         ec=zeros(size(ee));
0198         <span class="keyword">for</span> i=1:size(ec,2);
0199            ec(:,i) = any( ee(:,i*oo)==nn, 2);
0200         <span class="keyword">end</span>
0201         sels= find(all(ec'));
0202 
0203         <span class="keyword">for</span> u=1:length(sels)
0204             ee= <a href="#_sub14" class="code" title="subfunction ee= get_boundary( mdl )">get_boundary</a>( mdl );
0205             <a href="#_sub7" class="code" title="subfunction paint_electrodes(sel,srf,vtx, colour, show_num);">paint_electrodes</a>(sels(u), ee, <span class="keyword">...</span>
0206                              mdl.nodes, colour, <span class="keyword">...</span>
0207                              number_electrodes);
0208         <span class="keyword">end</span>
0209         <span class="keyword">if</span> number_electrodes
0210             el_nodes= mdl.nodes(unique(mdl.boundary(sels,:)),:);
0211             hh=text( mean(el_nodes(:,1)), <span class="keyword">...</span>
0212                      mean(el_nodes(:,2)), <span class="keyword">...</span>
0213                      mean(el_nodes(:,3)), num2str(e) );
0214             set(hh,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Color'</span>,[.6,0,0]);
0215         <span class="keyword">end</span>
0216     <span class="keyword">end</span>
0217 <span class="keyword">end</span>
0218 
0219 <a name="_sub6" href="#_subfunctions" class="code">function show_inhomogeneities( elem_data, mdl, img)</a>
0220 <span class="comment">% show</span>
0221 <span class="keyword">if</span> size(elem_data,2)&gt;1
0222    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: show_fem only shows first image'</span>,1);
0223 <span class="keyword">end</span>
0224 <a href="repaint_inho.html" class="code" title="function repaint_inho(mat,mat_ref,vtx,simp, thresh, clr_def);">repaint_inho</a>(elem_data(:,1), <span class="string">'use_global'</span> , mdl.nodes, mdl.elems, [], img); 
0225 <span class="keyword">if</span> ~exist(<span class="string">'OCTAVE_VERSION'</span>);
0226 camlight(<span class="string">'left'</span>);
0227 lighting(<span class="string">'none'</span>); <span class="comment">% lighting doesn't help much</span>
0228 <span class="keyword">end</span>
0229 
0230 <a name="_sub7" href="#_subfunctions" class="code">function paint_electrodes(sel,srf,vtx, colour, show_num);</a>
0231 <span class="comment">%function paint_electrodes(sel,srf,vtx);</span>
0232 <span class="comment">%</span>
0233 <span class="comment">% plots the electrodes red at the boundaries.</span>
0234 <span class="comment">%</span>
0235 <span class="comment">% sel = The index of the electrode faces in the srf matrix</span>
0236 <span class="comment">%       sel can be created by set_electrodes.m</span>
0237 <span class="comment">% srf = the boundary faces (triangles)</span>
0238 <span class="comment">% vtx = The vertices matrix.</span>
0239 
0240 l = srf(sel,1); m = srf(sel,2); n = srf(sel,3);
0241 
0242 Xs = [vtx(l,1);vtx(m,1);vtx(n,1)];
0243 Ys = [vtx(l,2);vtx(m,2);vtx(n,2)];
0244 Zs = [vtx(l,3);vtx(m,3);vtx(n,3)];
0245 
0246 h=patch(Xs,Ys,Zs, colour);
0247 <span class="comment">% need 'direct' otherwise colourmap is screwed up</span>
0248 set(h, <span class="string">'FaceLighting'</span>,<span class="string">'none'</span>, <span class="string">'CDataMapping'</span>, <span class="string">'direct'</span> );
0249 
0250 <a name="_sub8" href="#_subfunctions" class="code">function hh= show_3d_fem( mdl, options )</a>
0251    ee= <a href="#_sub14" class="code" title="subfunction ee= get_boundary( mdl )">get_boundary</a>( mdl );
0252    hh= trimesh(ee, mdl.nodes(:,1), <span class="keyword">...</span>
0253                    mdl.nodes(:,2), <span class="keyword">...</span>
0254                    mdl.nodes(:,3));
0255    set(hh, <span class="string">'EdgeColor'</span>, [0,0,0]);
0256    axis(<span class="string">'image'</span>);
0257    set(gcf,<span class="string">'Colormap'</span>,[0 0 0]);
0258    hidden(<span class="string">'off'</span>);
0259 
0260 <a name="_sub9" href="#_subfunctions" class="code">function hh=show_2d_fem( mdl, colours, imgno )</a>
0261   szcolr = size(colours);
0262   <span class="keyword">if</span> nargin&lt;3;
0263       imgno = 1;
0264       <span class="keyword">if</span> szcolr(1:2)&gt;1;  <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: show_fem only shows first image'</span>,1); <span class="keyword">end</span>
0265   <span class="keyword">end</span>
0266   
0267 <span class="comment">% el_pos= avg_electrode_posn( mdl );</span>
0268 <span class="comment">% plot_2d_mesh(mdl.nodes', mdl.elems', el_pos', .95, [0,0,0]);</span>
0269 
0270   S= 1; <span class="comment">%.95; % shrink factor</span>
0271   elem= mdl.elems'; e= size(elem,2);
0272   node= mdl.nodes'; n= size(node,2);
0273   Xs=zeros(3,e);
0274   Xs(:)=mdl.nodes(elem(:),1);
0275   Xs= S*Xs+ (1-S)*ones(3,1)*mean(Xs);
0276   Ys=zeros(3,e); Ys(:)=mdl.nodes(elem(:),2);
0277   Ys= S*Ys+ (1-S)*ones(3,1)*mean(Ys);
0278   Zs = zeros(size(Xs));
0279   <span class="keyword">if</span> szcolr(1:2) == [1,3]  <span class="comment">% no reconstruction  - just use white</span>
0280      hh= patch(Xs,Ys,zeros(3,e),colours);
0281   <span class="keyword">elseif</span> size(colours,1) == e <span class="comment">% defined on elems</span>
0282 <span class="comment">% THE STUPID MATLAB 7 WILL RESET THE COLOURBAR WHENEVER YOU DO A PATCH. DAMN.</span>
0283      colours = permute(colours(:,imgno,:),[2,1,3]);
0284   <span class="keyword">elseif</span> size(colours,1) == n  <span class="comment">% multiple images</span>
0285      colours = colours(elem(:), imgno, :);
0286      colours = reshape( colours, size(elem,1), size(elem,2), []);
0287   <span class="keyword">else</span>
0288     <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: image elements and mesh do not match. Showing grey'</span>,1);
0289     colours= [1,1,1]/2; <span class="comment">% Grey to show we're not sure</span>
0290   <span class="keyword">end</span>
0291 
0292   hh= patch(Xs,Ys,Zs,colours);
0293   set(hh, <span class="string">'FaceLighting'</span>,<span class="string">'none'</span>, <span class="string">'CDataMapping'</span>, <span class="string">'direct'</span> );
0294   <span class="comment">% FOR NODE RGB MATLAB SCREWS UP THE COLOURS FOR US (ONCE AGAIN). THERE MUST</span>
0295   <span class="comment">% BE SOME KIND OF SECRET FLAG@@@</span>
0296 
0297   max_x= max(mdl.nodes(:,1)); min_x= min(mdl.nodes(:,1));
0298   max_y= max(mdl.nodes(:,2)); min_y= min(mdl.nodes(:,2));
0299   axis([ mean([max_x,min_x]) + 0.55*[-1,1]*(max_x-min_x), <span class="keyword">...</span>
0300          mean([max_y,min_y]) + 0.55*[-1,1]*(max_y-min_y) ]);
0301 
0302 
0303 
0304 <a name="_sub10" href="#_subfunctions" class="code">function old_code_3d_plot</a>
0305   domesnum= 0;
0306   donodenum= 0;
0307   dotext=0;
0308 
0309   xxx=zeros(4,e); xxx(:)=NODE(1,ELEM(:));
0310   xxx= S*xxx+ (1-S)*ones(4,1)*mean(xxx);
0311   yyy=zeros(4,e); yyy(:)=NODE(2,ELEM(:));
0312   yyy= S*yyy+ (1-S)*ones(4,1)*mean(yyy);
0313   zzz=zeros(4,e); zzz(:)=NODE(3,ELEM(:));
0314   zzz= S*zzz+ (1-S)*ones(4,1)*mean(zzz);
0315   plot3( xxx([1 2 3 1 4 2 3 4],:), <span class="keyword">...</span>
0316          yyy([1 2 3 1 4 2 3 4],:), <span class="keyword">...</span>
0317          zzz([1 2 3 1 4 2 3 4],:),<span class="string">'k'</span> );
0318   hold on;
0319   xy=NODE(1:2,MES(1,:));
0320   plot3(arrow*xy,arrow*[0 1;-1 0]*xy,ones(8,1)*NODE(3,MES(1,:)),<span class="string">'b'</span>) 
0321   hold off;
0322   axis([ [-1.1 1.1]*max(NODE(1,:)) [-1.1 1.1]*max(NODE(2,:)) <span class="keyword">...</span>
0323          [-1.1 1.1]*max(NODE(3,:))  ])
0324 
0325 
0326 <a name="_sub11" href="#_subfunctions" class="code">function plot_2d_mesh(NODE,ELEM,el_pos, S, options)</a>
0327 <span class="comment">%  if options(1) -&gt; do mesh num</span>
0328 <span class="comment">%  if options(2) -&gt; do node num</span>
0329 <span class="comment">%  if options(3) -&gt; do text</span>
0330 <span class="comment">%  S=.95; % shrink simplices by this factor</span>
0331 
0332   e=size(ELEM,2);
0333   d=size(ELEM,1);
0334   R= zeros(1,e);
0335 
0336 
0337   arrow= [1.02 0;1.06 .05;1.06 .02;1.1 .02; <span class="keyword">...</span>
0338           1.1 -.02; 1.06 -.02;1.06 -.05;1.02 0];
0339   <span class="comment">% arrow= [1.06 0;1.18 .15;1.18 .06;1.3 .06; ...</span>
0340   <span class="comment">%          1.3 -.06; 1.18 -.06;1.18 -.15;1.06 0];</span>
0341   xxx=zeros(3,e); xxx(:)=NODE(1,ELEM(:));
0342   xxx= S*xxx+ (1-S)*ones(3,1)*mean(xxx);
0343   xxx= [xxx;xxx(1,:)];
0344 
0345   yyy=zeros(3,e); yyy(:)=NODE(2,ELEM(:));
0346   yyy= S*yyy+ (1-S)*ones(3,1)*mean(yyy);
0347   yyy= [yyy;yyy(1,:)];
0348 
0349   <span class="keyword">if</span> isempty(el_pos)
0350       plot(xxx,yyy,<span class="string">'b'</span>);
0351   <span class="keyword">else</span>
0352       xy= el_pos;
0353       hh=plot([xxx;xxx(1,:)],[yyy;yyy(1,:)],<span class="string">'b'</span>, <span class="keyword">...</span>
0354               arrow*xy,arrow*[0 1;-1 0]*xy,<span class="string">'r'</span>);
0355       set(hh(find(R&gt;0)),<span class="string">'Color'</span>,[1 0 0],<span class="string">'LineWidth'</span>,2);
0356       set(hh(find(R&lt;0)),<span class="string">'Color'</span>,[0 0 1],<span class="string">'LineWidth'</span>,2);
0357   <span class="keyword">end</span>
0358 
0359   <span class="keyword">if</span> options(1) <span class="comment">%domesnum</span>
0360     mesnum= reshape(sprintf(<span class="string">' %-2d'</span>,[0:15]),3,16)';
0361     text(NODE(1,MES(1,:))*1.08,NODE(2,MES(1,:))*1.08,mesnum, <span class="keyword">...</span>
0362          <span class="string">'Color'</span>,<span class="string">'green'</span>,<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>);
0363   <span class="keyword">end</span> <span class="comment">%if domesnum</span>
0364 
0365   <span class="keyword">if</span> options(2) <span class="comment">%donodenum</span>
0366     nodenum= reshape(sprintf(<span class="string">'%3d'</span>,1:length(NODE)),3,length(NODE))';
0367     text(NODE(1,:),NODE(2,:),nodenum, <span class="keyword">...</span>
0368          <span class="string">'Color'</span>,<span class="string">'yellow'</span>,<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>,<span class="string">'FontSize'</span>,14);
0369   <span class="keyword">end</span> <span class="comment">%if domesnum</span>
0370 
0371   <span class="keyword">if</span> options(3) <span class="comment">%dotext</span>
0372     numeros= reshape(sprintf(<span class="string">'%4d'</span>,[1:e]),4,e)';
0373 <span class="comment">%   decal= ( 2-0.2*floor(log10([1:e]')))*sqrt(axis*axis'/4)/100;</span>
0374     decal= .02;
0375     xcoor=mean(NODE(2*ELEM-1))';
0376     ycoor=mean(NODE(2*ELEM))';
0377     text(xcoor-decal,ycoor,numeros,<span class="string">'FontSize'</span>,8, <span class="keyword">...</span>
0378          <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>);
0379 
0380   <span class="keyword">end</span>  <span class="comment">% if nargin~=0</span>
0381   axis([ [-1.1 1.1]*max(NODE(1,:)) [-1.1 1.1]*max(NODE(2,:)) ])
0382 
0383 <a name="_sub12" href="#_subfunctions" class="code">function  mes= avg_electrode_posn( mdl )</a>
0384    <span class="keyword">if</span> ~isfield(mdl,<span class="string">'electrode'</span>); mes=[]; <span class="keyword">return</span>; <span class="keyword">end</span>
0385    n_elec= length( mdl.electrode );
0386    nodes = mdl.nodes;
0387    mes= zeros( n_elec, <a href="../../eidors/models/a_adler/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>(mdl) )
0388    <span class="keyword">for</span> i= 1:n_elec
0389       e_nodes=  mdl.electrode(i).nodes;
0390       mes(i,:)= mean( nodes(e_nodes,:) , 1 );
0391    <span class="keyword">end</span>
0392 
0393 <a name="_sub13" href="#_subfunctions" class="code">function colour= electr_colour( e);</a>
0394     <span class="keyword">if</span> e==1;
0395        colour = [0,.7,0]; <span class="comment">% light green electrode #1</span>
0396     <span class="keyword">elseif</span> e==2
0397        colour = [0,.5,0]; <span class="comment">% mid-green electrode #2</span>
0398     <span class="keyword">else</span>
0399        colour = [0,.3,0]; <span class="comment">% dark green</span>
0400     <span class="keyword">end</span>
0401 
0402 <a name="_sub14" href="#_subfunctions" class="code">function ee= get_boundary( mdl )</a>
0403    <span class="keyword">if</span> isfield(mdl,<span class="string">'boundary'</span>)
0404        ee= mdl.boundary;
0405    <span class="keyword">else</span>
0406        <span class="comment">% calc and cache boundary</span>
0407        ee = <a href="../../eidors/algorithms/n_polydorides/find_boundary.html" class="code" title="function [srf, idx] = find_boundary(simp);">find_boundary</a>( mdl.elems );
0408    <span class="keyword">end</span>
0409 
0410 
0411 <span class="comment">% TESTS:</span>
0412 <a name="_sub15" href="#_subfunctions" class="code">function do_unit_test</a>
0413    clf
0414 
0415    img=<a href="../../eidors/algorithms/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(<a href="../../eidors/models/a_adler/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c0'</span>,8)); 
0416    img.elem_data=rand(size(img.fwd_model.elems,1),1);
0417    subplot(3,4,1); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img.fwd_model,[0,0,1]) 
0418    title(<span class="string">'regular mesh numbered'</span>);
0419 
0420    imgn = rmfield(img,<span class="string">'elem_data'</span>);
0421    imgn.node_data=rand(size(img.fwd_model.nodes,1),1);
0422    subplot(3,4,9); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(imgn) 
0423    title(<span class="string">'interpolated node colours'</span>);
0424 
0425    img2(1) = img; img2(2) = img;
0426    subplot(3,4,2); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img,[1]);
0427    title(<span class="string">'colours with legend'</span>);
0428    subplot(3,4,3); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img2,[0,1]);
0429    title(<span class="string">'colours with legend'</span>);
0430    img.calc_colours.mapped_colour = 0; <span class="comment">% USE RGB colours</span>
0431    subplot(3,4,4); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img,[0,1,1]);
0432    title(<span class="string">'RGB colours'</span>);
0433    subplot(3,4,4); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img);
0434    title(<span class="string">'RGB colours'</span>);
0435 
0436    imgn.calc_colours.mapped_colour = 0; <span class="comment">% USE RGB colours</span>
0437    subplot(3,4,10);<a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(imgn,[0,1]) 
0438    title(<span class="string">'interpolated node colours'</span>);
0439 
0440 
0441    subplot(3,4,11);hh=<a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(imgn); set(hh,<span class="string">'EdgeColor'</span>,[0,0,1]);
0442    title(<span class="string">'with edge colours'</span>);
0443 
0444    imgn.node_data = [1:10];
0445    subplot(3,4,12);<a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(imgn); <span class="comment">%Should show grey</span>
0446    title(<span class="string">'error -&gt; show grey'</span>);
0447 
0448    img3=<a href="../../eidors/algorithms/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(<a href="../../eidors/models/a_adler/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>,8));
0449    img3.elem_data= randn(828,1);                       
0450    subplot(3,4,5); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3.fwd_model) 
0451    subplot(3,4,6); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3,[1])
0452    subplot(3,4,7); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3,[1,1])
0453    subplot(3,4,8); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3,[1,1,1])
0454</pre></div>
<hr><address>Generated on Tue 09-Aug-2011 11:38:31 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>