<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of calc_colours</title>
  <meta name="keywords" content="calc_colours">
  <meta name="description" content="[colours,scl_data]= calc_colours(img, set_value, do_colourbar)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html?eidors/graphics_matlab/calc_colours.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html eidors --><!-- menu.html graphics_matlab -->
<h1>calc_colours
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>[colours,scl_data]= calc_colours(img, set_value, do_colourbar)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [colours,scl_data]= calc_colours(img, set_value, do_colourbar) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> [colours,scl_data]= calc_colours(img, set_value, do_colourbar)
 Calculate a colour for each image element 

 Conductive (positive) areas are shown in red
 Non-Conductive (negative) areas are shown in blue

 PARAMETERS: img
     - 1) an EIDORS image object, or a Ex1 vector
     - 2) a 2D image matrix

 Usage #1 (img is a Ex1 vector of element conductivities)

   Cs = calc_colours( img);
   patch(Xs,Ys,Zs,Cs);

 Cs is Ex1x1 colourmap entries (if mapped_colour&gt;0)
       Ex1x3 colourmap entries (if mapped_colour==0)

 Usage #2 (rimg is a MxN image matrix of reconstructed pixels):
           img is an image structure with the image properties
  
   c_img = calc_colours( rimg, img);
   image( c_img );

 c_img is MxN colourmap entries (if mapped_colour&gt;0)
          MxNx3 colourmap entries (if mapped_colour==0)

 Usage #3 (img is string parameter value)
  
   value = calc_colours( 'param' );
   calc_colours( 'param', value );
    eg. calc_colours('mapped_colour',127)
         Use this to allow printing vector eps files to get around
         a matlab bug with warning 'RGB color data not ...'

   The following parameters are accepted

   'greylev'    (DEFAULT -.01): the colour of the ref_level.
      Negative values indicate white background
      For almost white, greylev=-.01; Black=&gt; greylev=.01
   'sat_adj'    (DEFAULT .9): max G,B when R=1
   'window_range' (DEFAULT .9); window colour range
      Colour slope outside range is 1/3 of centre slope
   'backgnd' ( DEFAULT [.5,.5,.15] ): image border colour 
   'ref_level' (DEFAULT 'auto') conductivity of centre of
      colour mapping. 'auto' tries to estimate a good level.
   'mapped_colour' (DEFAULT 127) number of colourmap entries
      using mapped_colour allows matlab to print vector graphics to eps
      setting mapped_colour=0 means to use RGB colours
   'npoints' (DEFAULT 64) number of points accross the image
   'clim'    (DEFAULT []) crop colour display of values above clim
           colour limit. values more different from ref_level are cropped.
           if not specified or clim==[] =&gt; no limit
   'cmap_type'  Specify special colours (Default 'blue_red')
           if 'draeger' use the Draegerwerk/Amato colourmap
           if 'jet' use the matlab jet colourmap
   'cb_shrink_move' shrink or move the colorbar. See eidors_colourbar
           help for details.

   'colourmap' Return the current EIDORS colormap. 
           Use as colormap(calc_colours('colourmap'))

 PARAMETERS CAN BE SPECIFIED IN TWO WAYS
   1. as an image parameter (ie clim in img.calc_colours.clim)
   2. a second parameter to ( calc_colours(data, param2 )
          where param2.calc_colours.clim= ... etc
   3. parameter to calc_colours('clim')

 Parameters specified as (1) will override (2)

 PARAMETERS: do_colourbar
    - show a Matlab colorbar with appropriate scaling

  usage: c_img= calc_colours( img, clim );
         image( c_img );
         calc_colours( img, clim, 1); %now do colorbar 

 PARAMETERS: ref_lev
     - if specified, override the global ref_level parameter</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/algorithms/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>	GET_IMG_DATA: get parameter data from eidors image object</li><li><a href="../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>	EIDORS_OBJ: 'constructor' to create a eidors structure</li><li><a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>	[colours,scl_data]= calc_colours(img, set_value, do_colourbar)</li><li><a href="eidors_colourbar.html" class="code" title="function eidors_colourbar(max_scale,ref_lev, cb_shrink_move)">eidors_colourbar</a>	EIDORS_COLOURBAR - create an eidors colourbar with scaling to image</li><li><a href="scale_for_display.html" class="code" title="function [elem_data,ref_lev,max_scale] = scale_for_display( elem_data, ref_lev, clim )">scale_for_display</a>	[elem_data,ref_lev,max_scale] = scale_for_display( elem_data, ref_lev, clim )</li><li><a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/algorithms/a_adler/calc_posn_resolution.html" class="code" title="function [br,pos]= calc_posn_resolution( img, fwd_model)">calc_posn_resolution</a>	CALC_POSN_RESOLUTION: calculate posn and resolution of a target</li><li><a href="../../eidors/examples/compare_2d_algs.html" class="code" title="function [imgr, img]= compare_2d_algs(option,shape);">compare_2d_algs</a>	Compare different 2D reconstructions</li><li><a href="../../eidors/examples/compare_3d_algs.html" class="code" title="function imgr= compare_3d_algs( algno )">compare_3d_algs</a>	Compare different 3D reconstructions</li><li><a href="animate_reconstructions.html" class="code" title="function fname_out= animate_reconstructions(fname, imgs);">animate_reconstructions</a>	animate_reconstructions(fname, imgs);</li><li><a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>	[colours,scl_data]= calc_colours(img, set_value, do_colourbar)</li><li><a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>	calc_slices (img, levels, clim  ) show slices at levels of an</li><li><a href="repaint_inho.html" class="code" title="function repaint_inho(mat,mat_ref,vtx,simp, thresh, clr_def);">repaint_inho</a>	function repaint_inho(mat,mat_ref,vtx,simp, thresh);</li><li><a href="show_3d_slices.html" class="code" title="function show_3d_slices(img, varargin);">show_3d_slices</a>	show_3d_slices(img, z_cuts, x_cuts, y_cuts)</li><li><a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>	SHOW_FEM: show the EIDORS3D finite element model</li><li><a href="show_slices.html" class="code" title="function out_img= show_slices( img, levels )">show_slices</a>	out_img = show_slices (img, levels ) show slices at levels of an</li><li><a href="show_slices_move.html" class="code" title="function show_slices_move( img, move, move_scale )">show_slices_move</a>	SHOW_SLICES_MOVE   Shows planar slices of a 3D FEM with movement vectors</li><li><a href="slicer_plot_n.html" class="code" title="function [fc] = slicer_plot_n(h,sol,vtx,simp,fc);">slicer_plot_n</a>	function [fc] = slicer_plot_n(h,sol,vtx,simp,fc);</li><li><a href="../../eidors/startup.html" class="code" title="function startup">startup</a>	Script to start EIDORS</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [red,grn,blu] = blu_red_axis( pp, scale_data, backgnd )</a></li><li><a href="#_sub2" class="code">function [red,grn,blu]= blue_red_colours(pp,scale_data);</a></li><li><a href="#_sub3" class="code">function [red,grn,blu] = draeger_colours(pp,scale_data);</a></li><li><a href="#_sub4" class="code">function [red,grn,blu] = jet_colours(pp,scale_data);</a></li><li><a href="#_sub5" class="code">function pp=get_colours( img );</a></li><li><a href="#_sub6" class="code">function BGI= backgndidx;</a></li><li><a href="#_sub7" class="code">function colours=set_mapped_colour(pp, backgnd, img_data)</a></li><li><a href="#_sub8" class="code">function value= get_field(param);</a></li><li><a href="#_sub9" class="code">function value= set_field(param, value);</a></li><li><a href="#_sub10" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)</a>
0002 <span class="comment">% [colours,scl_data]= calc_colours(img, set_value, do_colourbar)</span>
0003 <span class="comment">% Calculate a colour for each image element</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% Conductive (positive) areas are shown in red</span>
0006 <span class="comment">% Non-Conductive (negative) areas are shown in blue</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% PARAMETERS: img</span>
0009 <span class="comment">%     - 1) an EIDORS image object, or a Ex1 vector</span>
0010 <span class="comment">%     - 2) a 2D image matrix</span>
0011 <span class="comment">%</span>
0012 <span class="comment">% Usage #1 (img is a Ex1 vector of element conductivities)</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%   Cs = calc_colours( img);</span>
0015 <span class="comment">%   patch(Xs,Ys,Zs,Cs);</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% Cs is Ex1x1 colourmap entries (if mapped_colour&gt;0)</span>
0018 <span class="comment">%       Ex1x3 colourmap entries (if mapped_colour==0)</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Usage #2 (rimg is a MxN image matrix of reconstructed pixels):</span>
0021 <span class="comment">%           img is an image structure with the image properties</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%   c_img = calc_colours( rimg, img);</span>
0024 <span class="comment">%   image( c_img );</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% c_img is MxN colourmap entries (if mapped_colour&gt;0)</span>
0027 <span class="comment">%          MxNx3 colourmap entries (if mapped_colour==0)</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% Usage #3 (img is string parameter value)</span>
0030 <span class="comment">%</span>
0031 <span class="comment">%   value = calc_colours( 'param' );</span>
0032 <span class="comment">%   calc_colours( 'param', value );</span>
0033 <span class="comment">%    eg. calc_colours('mapped_colour',127)</span>
0034 <span class="comment">%         Use this to allow printing vector eps files to get around</span>
0035 <span class="comment">%         a matlab bug with warning 'RGB color data not ...'</span>
0036 <span class="comment">%</span>
0037 <span class="comment">%   The following parameters are accepted</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%   'greylev'    (DEFAULT -.01): the colour of the ref_level.</span>
0040 <span class="comment">%      Negative values indicate white background</span>
0041 <span class="comment">%      For almost white, greylev=-.01; Black=&gt; greylev=.01</span>
0042 <span class="comment">%   'sat_adj'    (DEFAULT .9): max G,B when R=1</span>
0043 <span class="comment">%   'window_range' (DEFAULT .9); window colour range</span>
0044 <span class="comment">%      Colour slope outside range is 1/3 of centre slope</span>
0045 <span class="comment">%   'backgnd' ( DEFAULT [.5,.5,.15] ): image border colour</span>
0046 <span class="comment">%   'ref_level' (DEFAULT 'auto') conductivity of centre of</span>
0047 <span class="comment">%      colour mapping. 'auto' tries to estimate a good level.</span>
0048 <span class="comment">%   'mapped_colour' (DEFAULT 127) number of colourmap entries</span>
0049 <span class="comment">%      using mapped_colour allows matlab to print vector graphics to eps</span>
0050 <span class="comment">%      setting mapped_colour=0 means to use RGB colours</span>
0051 <span class="comment">%   'npoints' (DEFAULT 64) number of points accross the image</span>
0052 <span class="comment">%   'clim'    (DEFAULT []) crop colour display of values above clim</span>
0053 <span class="comment">%           colour limit. values more different from ref_level are cropped.</span>
0054 <span class="comment">%           if not specified or clim==[] =&gt; no limit</span>
0055 <span class="comment">%   'cmap_type'  Specify special colours (Default 'blue_red')</span>
0056 <span class="comment">%           if 'draeger' use the Draegerwerk/Amato colourmap</span>
0057 <span class="comment">%           if 'jet' use the matlab jet colourmap</span>
0058 <span class="comment">%   'cb_shrink_move' shrink or move the colorbar. See eidors_colourbar</span>
0059 <span class="comment">%           help for details.</span>
0060 <span class="comment">%</span>
0061 <span class="comment">%   'colourmap' Return the current EIDORS colormap.</span>
0062 <span class="comment">%           Use as colormap(calc_colours('colourmap'))</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% PARAMETERS CAN BE SPECIFIED IN TWO WAYS</span>
0065 <span class="comment">%   1. as an image parameter (ie clim in img.calc_colours.clim)</span>
0066 <span class="comment">%   2. a second parameter to ( calc_colours(data, param2 )</span>
0067 <span class="comment">%          where param2.calc_colours.clim= ... etc</span>
0068 <span class="comment">%   3. parameter to calc_colours('clim')</span>
0069 <span class="comment">%</span>
0070 <span class="comment">% Parameters specified as (1) will override (2)</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% PARAMETERS: do_colourbar</span>
0073 <span class="comment">%    - show a Matlab colorbar with appropriate scaling</span>
0074 <span class="comment">%</span>
0075 <span class="comment">%  usage: c_img= calc_colours( img, clim );</span>
0076 <span class="comment">%         image( c_img );</span>
0077 <span class="comment">%         calc_colours( img, clim, 1); %now do colorbar</span>
0078 <span class="comment">%</span>
0079 <span class="comment">% PARAMETERS: ref_lev</span>
0080 <span class="comment">%     - if specified, override the global ref_level parameter</span>
0081 <span class="comment">%</span>
0082 
0083 <span class="comment">% (C) 2005-2008 Andy Adler. License: GPL version 2 or version 3</span>
0084 <span class="comment">% $Id$</span>
0085 
0086 <span class="keyword">if</span> nargin==0; error(<span class="string">'calc_colours: expecting argument'</span>); <span class="keyword">end</span>
0087 <span class="keyword">if</span> isstr(img) &amp;&amp; strcmp(img,<span class="string">'UNIT_TEST'</span>); <a href="#_sub10" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0088 
0089 <span class="keyword">if</span> ischar(img)
0090     <span class="comment">% called as calc_colours('parameter' ... )</span>
0091     <span class="keyword">if</span> nargin==1;
0092        colours= <a href="#_sub8" class="code" title="subfunction value= get_field(param);">get_field</a>(img);
0093     <span class="keyword">else</span>
0094        colours= <a href="#_sub9" class="code" title="subfunction value= set_field(param, value);">set_field</a>(img, set_value);
0095     <span class="keyword">end</span>
0096     <span class="keyword">return</span>;
0097 
0098 <span class="keyword">elseif</span> isfield(img,<span class="string">'type'</span>)
0099    img_data= <a href="../../eidors/algorithms/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>( img );
0100    pp=<a href="#_sub5" class="code" title="subfunction pp=get_colours( img );">get_colours</a>(img(1)) ;
0101 <span class="keyword">else</span>
0102    img_data= img;
0103 
0104    <span class="keyword">if</span> nargin==1
0105       pp=<a href="#_sub5" class="code" title="subfunction pp=get_colours( img );">get_colours</a>( [] ); 
0106    <span class="keyword">else</span>
0107       pp=<a href="#_sub5" class="code" title="subfunction pp=get_colours( img );">get_colours</a>(set_value); 
0108    <span class="keyword">end</span>
0109 <span class="keyword">end</span>
0110 
0111 <span class="comment">% Set default parameters</span>
0112 <span class="keyword">if</span> nargin &lt; 3; do_colourbar = 0;       <span class="keyword">end</span>
0113 ref_lev = <span class="string">'use_global'</span>;
0114 
0115 
0116 <span class="keyword">if</span> isempty(img_data)
0117     colours = <span class="string">'k'</span>; <span class="comment">%black</span>
0118     <span class="keyword">return</span>;
0119 <span class="keyword">end</span>
0120 
0121 m= size(img_data,1); n=size(img_data,2);
0122 
0123 <span class="comment">% We can only plot the real part of data</span>
0124 <span class="comment">% Vectorize img_data here, it gets reshaped later</span>
0125 [scl_data, ref_lev, max_scale] = <span class="keyword">...</span>
0126       <a href="scale_for_display.html" class="code" title="function [elem_data,ref_lev,max_scale] = scale_for_display( elem_data, ref_lev, clim )">scale_for_display</a>( real(img_data(:)), pp.ref_level, pp.clim );
0127 
0128 backgnd= isnan(scl_data);
0129 scl_data(backgnd)= mean( scl_data(~backgnd));
0130 
0131 <span class="keyword">if</span> pp.mapped_colour
0132    colours=<a href="#_sub7" class="code" title="subfunction colours=set_mapped_colour(pp, backgnd, img_data)">set_mapped_colour</a>(pp, backgnd, scl_data);
0133    colours= reshape( colours, m,n,[]);
0134 <span class="keyword">else</span>
0135    [red,grn,blu] = <a href="#_sub1" class="code" title="subfunction [red,grn,blu] = blu_red_axis( pp, scale_data, backgnd )">blu_red_axis</a>( pp, scl_data, backgnd );
0136    colours= reshape( [red,grn,blu],m,n,3);
0137 <span class="keyword">end</span>
0138 
0139 <span class="comment">% print colorbar if do_colourbar is specified</span>
0140 <span class="keyword">if</span> do_colourbar
0141    <span class="keyword">if</span> ~pp.mapped_colour
0142        warning(<span class="string">'Colorbar not available without mapped_colour option'</span>);
0143    <span class="keyword">else</span>
0144        <a href="eidors_colourbar.html" class="code" title="function eidors_colourbar(max_scale,ref_lev, cb_shrink_move)">eidors_colourbar</a>(max_scale,ref_lev,pp.cb_shrink_move)
0145    <span class="keyword">end</span>
0146 <span class="keyword">end</span>
0147 
0148 
0149 <span class="comment">%scaled data must go from -1 to 1</span>
0150 <a name="_sub1" href="#_subfunctions" class="code">function [red,grn,blu] = blu_red_axis( pp, scale_data, backgnd )</a>
0151    <span class="keyword">if</span> ~isfield(pp,<span class="string">'cmap_type'</span>)
0152       pp.cmap_type = <span class="string">'blue_red'</span>;
0153    <span class="keyword">end</span>; 
0154 
0155    <span class="comment">% window data such that slope above w is 1/3 of that below</span>
0156    <span class="comment">% thus w is mapped to k st k/w = 3(1-k)/(1-w) -&gt; k=3w/(1+2w)</span>
0157    W= pp.window_range; K= 3*W/(1+2*W);
0158    scale_data= sign(scale_data) .* ( <span class="keyword">...</span>
0159      (  K/W*   abs(scale_data)   ) .* (abs(scale_data)&lt;=W) + <span class="keyword">...</span>
0160      (K+K/W/3*(abs(scale_data)-W)) .* (abs(scale_data)&gt; W) );
0161 
0162    <span class="keyword">switch</span> pp.cmap_type
0163      <span class="keyword">case</span> {<span class="string">'blue_red'</span>,<span class="string">''</span>}
0164       [red,grn,blu]= <a href="#_sub2" class="code" title="subfunction [red,grn,blu]= blue_red_colours(pp,scale_data);">blue_red_colours</a>(pp,scale_data);
0165      <span class="keyword">case</span> <span class="string">'draeger'</span>
0166       [red,grn,blu]= <a href="#_sub3" class="code" title="subfunction [red,grn,blu] = draeger_colours(pp,scale_data);">draeger_colours</a>(pp,scale_data);
0167      <span class="keyword">case</span> <span class="string">'jet'</span>
0168       [red,grn,blu]= <a href="#_sub4" class="code" title="subfunction [red,grn,blu] = jet_colours(pp,scale_data);">jet_colours</a>(pp,scale_data);
0169      <span class="keyword">case</span> <span class="string">'jetair'</span>
0170       <span class="comment">% Make most of the range for air -ve</span>
0171       scd = (scale_data + 0.5)/0.6;
0172       [red,grn,blu]= <a href="#_sub4" class="code" title="subfunction [red,grn,blu] = jet_colours(pp,scale_data);">jet_colours</a>(pp,scd);
0173      <span class="keyword">otherwise</span>
0174       error([<span class="string">'specified cmap_type not understood:'</span>,pp.cmap_type]);
0175    <span class="keyword">end</span>
0176 
0177    red(backgnd) = pp.backgnd(1);
0178    grn(backgnd) = pp.backgnd(2);
0179    blu(backgnd) = pp.backgnd(3);
0180 
0181 <a name="_sub2" href="#_subfunctions" class="code">function [red,grn,blu]= blue_red_colours(pp,scale_data);</a>
0182 <span class="keyword">if</span> 0
0183    D= sign(pp.greylev+eps); <span class="comment">%force 0 to 1</span>
0184    glev= abs(pp.greylev);
0185    F= 3*pp.sat_adj;
0186 
0187    red= D*F*abs(scale_data+D/F) - D + (D==-1);
0188    red= red.*(red&gt;0).*(red&lt;1) + (red&gt;=1);
0189    red= red*(1-glev) + glev;
0190 <span class="keyword">end</span>
0191    ofs= (pp.greylev &gt;= 0);   <span class="comment">% 1 if greylev&gt;=0</span>
0192    glev= abs(pp.greylev);
0193 
0194    D= (2*ofs - 1);
0195    ofs= ofs - 2*(ofs==0);
0196    F= 3*pp.sat_adj;
0197    DF= D*F; D_F= D/F;
0198 
0199    red= DF*abs(scale_data+D_F) - ofs;
0200    red= red.*(red&gt;0).*(red&lt;1) + (red&gt;=1);
0201 
0202    grn= DF*abs(scale_data    ) - ofs;
0203    grn= grn.*(grn&gt;0).*(grn&lt;1) + (grn&gt;=1);
0204 
0205    blu= DF*abs(scale_data-D_F) - ofs;
0206    blu= blu.*(blu&gt;0).*(blu&lt;1) + (blu&gt;=1);
0207 
0208    <span class="keyword">if</span> pp.greylev &gt;=0 <span class="comment">% Black background</span>
0209       red= red*(1-glev) + glev;
0210       grn= grn*(1-glev) + glev;
0211       blu= blu*(1-glev) + glev;
0212    <span class="keyword">else</span>
0213       red= red*(1-glev);
0214       grn= grn*(1-glev);
0215       blu= blu*(1-glev);
0216    <span class="keyword">end</span>
0217 
0218 <a name="_sub3" href="#_subfunctions" class="code">function [red,grn,blu] = draeger_colours(pp,scale_data);</a>
0219    grn=      (-scale_data&gt;0.2) .* (-scale_data - 0.2)/0.8;
0220    red=grn + ( scale_data&gt;0.2) .* ( scale_data - 0.2)/0.8*2/3;
0221 
0222    blu=      (-scale_data&gt;0.1) .* (-scale_data - 0.1)/0.1;
0223    blu(-scale_data&gt;0.2) = 1;
0224    blu=blu + ( scale_data&gt;0.2) .* ( scale_data - 0.2)/0.8*2/3;
0225 
0226 <span class="comment">% Sometimes this is just slightly &gt; 1</span>
0227    red(red&gt;1) = 1;
0228    grn(grn&gt;1) = 1;
0229    blu(blu&gt;1) = 1;
0230 
0231 <a name="_sub4" href="#_subfunctions" class="code">function [red,grn,blu] = jet_colours(pp,scale_data);</a>
0232    grn = 2*(3/4 - abs(scale_data));
0233    grn(grn&gt;1) = 1; grn(grn&lt;0) = 0;
0234 
0235    red = 1.5 - 2*abs(scale_data + 0.5);
0236    red(red&gt;1) = 1; red(red&lt;0) = 0;
0237 
0238    blu = 1.5 - 2*abs(scale_data - 0.5);
0239    blu(blu&gt;1) = 1; blu(blu&lt;0) = 0;
0240 
0241 <a name="_sub5" href="#_subfunctions" class="code">function pp=get_colours( img );</a>
0242    <span class="keyword">global</span> eidors_colours;
0243    pp= eidors_colours;
0244 
0245 <span class="comment">% override global if calc.colours specified</span>
0246    <span class="keyword">try</span>
0247 <span class="comment">% DAMN Matlab should have syntax for this loop</span>
0248       fds= fieldnames(img(1).calc_colours);<span class="comment">%assume all are the same!</span>
0249       <span class="keyword">for</span> fdn= fds(:)';
0250          fdn= fdn{1};
0251          pp.( fdn ) = img(1).calc_colours.(fdn);
0252       <span class="keyword">end</span>
0253    <span class="keyword">end</span>
0254 
0255 <a name="_sub6" href="#_subfunctions" class="code">function BGI= backgndidx;</a>
0256   BGI= 1;
0257 
0258 <a name="_sub7" href="#_subfunctions" class="code">function colours=set_mapped_colour(pp, backgnd, img_data)</a>
0259    <span class="comment">% need to generate a colourmap with pp.mapped_colour+1 elements</span>
0260    <span class="comment">% background pixel will be at entry #1. Thus for</span>
0261    <span class="comment">% mapped_colour= 3. CMAP = [backgnd,[-1 -.5  0 .5 1]</span>
0262    <span class="comment">%</span>
0263    <span class="comment">% Note: ensure patch uses 'direct' CDataMapping</span>
0264    ncol= pp.mapped_colour;
0265    [red,grn,blu] = <a href="#_sub1" class="code" title="subfunction [red,grn,blu] = blu_red_axis( pp, scale_data, backgnd )">blu_red_axis</a>( pp, <span class="keyword">...</span>
0266           [-1,linspace(-1,1,2*ncol - 1)]', backgndidx );
0267    colormap([red,grn,blu]);
0268 <span class="comment">% This is the line I wan't to write. However, matlab seems to waste</span>
0269 <span class="comment">%  lots of memory to do it. Instead we break it into pieces</span>
0270 <span class="comment">%  colours = fix( img_data * (ncol-1))' + ncol + 1;</span>
0271    colours = img_data'; colours = colours * (ncol-1);
0272    colours = fix ( colours ); colours = colours + ncol + 1;
0273    colours(backgnd)= backgndidx;
0274 
0275 <a name="_sub8" href="#_subfunctions" class="code">function value= get_field(param);</a>
0276     <span class="keyword">global</span> eidors_colours;
0277     <span class="keyword">if</span> strcmp(param,<span class="string">'colourmap'</span>)
0278        ncol= eidors_colours.mapped_colour;
0279        [red,grn,blu] = <a href="#_sub1" class="code" title="subfunction [red,grn,blu] = blu_red_axis( pp, scale_data, backgnd )">blu_red_axis</a>( eidors_colours, <span class="keyword">...</span>
0280               [-1,linspace(-1,1,2*ncol - 1)]', backgndidx );
0281        value= [red,grn,blu];
0282     <span class="keyword">else</span>
0283        value = getfield(eidors_colours, param);
0284     <span class="keyword">end</span>
0285 
0286 <a name="_sub9" href="#_subfunctions" class="code">function value= set_field(param, value);</a>
0287     <span class="keyword">global</span> eidors_colours;
0288     eidors_colours = setfield(eidors_colours, param, value);
0289     value= eidors_colours;
0290 
0291 <span class="comment">% TESTS:</span>
0292 <a name="_sub10" href="#_subfunctions" class="code">function do_unit_test</a>
0293    img = <a href="../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'image'</span>,<span class="string">'test'</span>); 
0294 
0295    img.calc_colours.mapped_colour = 127;
0296    img.calc_colours.ref_level = <span class="string">'auto'</span>;
0297    img.calc_colours.sat_adj = 0.9;
0298    img.calc_colours.window_range = 0.9;
0299    img.calc_colours.greylev = -0.01;
0300  
0301    img.elem_data = [-2;0;0;0;1;3];
0302    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cc01'</span>, <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img), [44; 128; 128; 128; 170; 254]);
0303 
0304    imgk(1) = img; imgk(2) = img;
0305    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cc01'</span>, <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(imgk), [44; 128; 128; 128; 170; 254]*[1,1]);
0306 
0307    img.calc_colours.ref_level = 1;
0308    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cc02'</span>, <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img), [ 2;  86;  86;  86; 128; 212]);
0309 
0310    img.calc_colours.greylev = -.1;
0311    img.calc_colours.mapped_colour = 0;
0312    img.elem_data = [-2;1;3];
0313    cm= reshape([ 0, 0.9, 0.9; 0, 0.9, 0.0643; 0.27, 0.9, 0]',[3,1,3]);
0314    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cc03'</span>, <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img), cm,1e-3)
0315 
0316    img.calc_colours.greylev =  .1;
0317    cm= reshape([ 0.73, 1.0, 1.0; 0.1, 0.1, 0.1; 1.0, 0.9357, 0.1],[3,1,3]);
0318    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cc04'</span>, <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img), cm,1e-3)
0319 
0320    <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(<span class="string">'greylev'</span>,0);
0321    <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(<span class="string">'sat_adj'</span>,1);
0322    <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(<span class="string">'mapped_colour'</span>,4);
0323    <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(<span class="string">'backgnd'</span>,[0.5,0.5,0.5]);
0324    cc= <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(<span class="string">'colourmap'</span>);
0325    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cc05'</span>,cc, [2,2,2;4,4,4;2,4,4;0,1,4;0,0,0;4,1,0;4,4,2;4,4,4]/4,1e-4);
0326 
0327 <span class="comment">% TESTS TO WRITE</span>
0328 <span class="comment">%   'greylev'    (DEFAULT -.01)</span>
0329 <span class="comment">%   'sat_adj'    (DEFAULT .9)</span>
0330 <span class="comment">%   'window_range' (DEFAULT .9)</span>
0331 <span class="comment">%   'backgnd' ( DEFAULT [.5,.5,.15] )</span>
0332 <span class="comment">%   'ref_level' (DEFAULT 'auto')</span>
0333 <span class="comment">%   'mapped_colour' (DEFAULT 127)</span>
0334 <span class="comment">%   'npoints' (DEFAULT 64)</span>
0335 <span class="comment">%   'clim'    (DEFAULT [])</span>
0336 <span class="comment">%   'cmap_type'  (Default blue-red)</span>
0337</pre></div>
<hr><address>Generated on Tue 09-Aug-2011 11:38:31 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>