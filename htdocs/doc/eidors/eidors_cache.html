<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of eidors_cache</title>
  <meta name="keywords" content="eidors_cache">
  <meta name="description" content="Control eidors_caching">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html eidors -->
<h1>eidors_cache
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Control eidors_caching</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function retval=eidors_cache( command, limit ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Control eidors_caching
 Usage: eidors_cache( command, limit )

 USAGE:
   eidors_cache( 'clear_all' ) 
   eidors_cache  clear

   eidors_cache( 'clear_old'. timestamp );
   eidors_cache( 'clear_new', timestamp );
      - clear all variables older (or newer) than timestamp
      - example:
         time_now= now;
         lots_of_eidors_calcs % don't need to cache this stuff
         eidors_cache('clear_new',time_now);

   eidors_cache( 'clear_max', memory_in_bytes );
      - clear cache so it has less than memory_in_bytes

   eidors_cache( 'cache_size', memory_in_bytes );
      - set max cache size to be memory_in_bytes
      - without 2nd arg will return current cache_size

   eidors_cache( 'clear_model_library' );
      - clear the eidors model library directory
      - NOTE: this function is experimental. 
      - TODO: add a way to specify what to clear
  
   eidors_cache( 'boost_priority', value)
      - modify the priority of the next cached items
      - low priority variables will be deleted first when memory is tight</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG: eidors progress and status messages</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../eidors/algorithms/a_adler/aa_system_mat_fields.html" class="code" title="function FC= aa_system_mat_fields( fwd_model )">aa_system_mat_fields</a>	AA_SYSTEM_MAT_FIELDS: fields (elem to nodes) fraction of system mat</li><li><a href="../eidors/algorithms/a_adler/calc_noise_figure.html" class="code" title="function [NF,SE] = calc_noise_figure( inv_model, hp, iterations)">calc_noise_figure</a>	CALC_NOISE_FIGURE: calculate the noise amplification (NF) of an algorithm</li><li><a href="../eidors/algorithms/a_adler/choose_noise_figure.html" class="code" title="function HP= choose_noise_figure( inv_model );">choose_noise_figure</a>	CHOOSE_NOISE_FIGURE: choose hyperparameter based on NF calculation</li><li><a href="../eidors/algorithms/a_adler/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>	INTERP_MESH: calculate interpolation points onto mdl elements</li><li><a href="eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>	EIDORS_OBJ: 'constructor' to create a eidors structure</li><li><a href="../eidors/meshing/netgen/ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>	NG_MAKE_CYL_MODELS: create cylindrical models using netgen</li><li><a href="../eidors/meshing/netgen/ng_mk_ellip_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_ellip_models(ellip_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_ellip_models</a>	NG_MAKE_ELLIP_MODELS: create elliptical models using netgen</li><li><a href="../eidors/meshing/netgen/ng_mk_extruded_model.html" class="code" title="function [fmdl,mat_idx] = ng_mk_extruded_model(shape, elec_pos, elec_shape,extra_ng_code)">ng_mk_extruded_model</a>	NG_MAKE_EXTRUDED_MODEL: create extruded models using netgen</li><li><a href="../eidors/meshing/netgen/ng_mk_gen_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_gen_models(shape_str, elec_pos,  elec_shape, elec_obj);">ng_mk_gen_models</a>	NG_MAKE_ELLIP_MODELS: create elliptical models using netgen</li><li><a href="startup.html" class="code" title="function startup">startup</a>	Script to start EIDORS</li><li><a href="../eidors/tests/cache_limit_test.html" class="code" title="function cache_limit_test">cache_limit_test</a>	Test cache deletes in the right order</li><li><a href="../eidors/tests/calc_model_prior_test.html" class="code" title="function ok= calc_model_prior_test;">calc_model_prior_test</a>	Verify model prior calcs</li><li><a href="../eidors/tests/test_c2f_jacobian.html" class="code" title="function test_c2f_jacobian">test_c2f_jacobian</a>	Test calc of jacobian given coarse to fine mapping</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [objid, times, sizes, prios, priidx] = get_names_times;</a></li><li><a href="#_sub2" class="code">function remove_objids( objid, sizes, idx)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function retval=eidors_cache( command, limit )</a>
0002 <span class="comment">% Control eidors_caching</span>
0003 <span class="comment">% Usage: eidors_cache( command, limit )</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% USAGE:</span>
0006 <span class="comment">%   eidors_cache( 'clear_all' )</span>
0007 <span class="comment">%   eidors_cache  clear</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%   eidors_cache( 'clear_old'. timestamp );</span>
0010 <span class="comment">%   eidors_cache( 'clear_new', timestamp );</span>
0011 <span class="comment">%      - clear all variables older (or newer) than timestamp</span>
0012 <span class="comment">%      - example:</span>
0013 <span class="comment">%         time_now= now;</span>
0014 <span class="comment">%         lots_of_eidors_calcs % don't need to cache this stuff</span>
0015 <span class="comment">%         eidors_cache('clear_new',time_now);</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%   eidors_cache( 'clear_max', memory_in_bytes );</span>
0018 <span class="comment">%      - clear cache so it has less than memory_in_bytes</span>
0019 <span class="comment">%</span>
0020 <span class="comment">%   eidors_cache( 'cache_size', memory_in_bytes );</span>
0021 <span class="comment">%      - set max cache size to be memory_in_bytes</span>
0022 <span class="comment">%      - without 2nd arg will return current cache_size</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%   eidors_cache( 'clear_model_library' );</span>
0025 <span class="comment">%      - clear the eidors model library directory</span>
0026 <span class="comment">%      - NOTE: this function is experimental.</span>
0027 <span class="comment">%      - TODO: add a way to specify what to clear</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%   eidors_cache( 'boost_priority', value)</span>
0030 <span class="comment">%      - modify the priority of the next cached items</span>
0031 <span class="comment">%      - low priority variables will be deleted first when memory is tight</span>
0032 
0033 <span class="comment">% (C) 2005 Andy Adler. Licensed under GPL version 2</span>
0034 <span class="comment">% $Id$</span>
0035 
0036 <span class="comment">% Comments</span>
0037 <span class="comment">% Want to clear specific structures</span>
0038 <span class="comment">%      to clear old variables</span>
0039 <span class="comment">%      to clear specific parts of structures</span>
0040 
0041 <span class="keyword">global</span> eidors_objects;
0042 <span class="keyword">if</span> nargin&lt;1
0043    fprintf(<span class="string">'EIDORS_CACHE: current max memory = %5.1fMB\n'</span>, <span class="keyword">...</span>
0044          eidors_objects.max_cache_size/1e6); 
0045    ww= whos(<span class="string">'eidors_objects'</span>);
0046    fprintf(<span class="string">'EIDORS_CACHE: cache memory used = %5.1fMB\n'</span>, <span class="keyword">...</span>
0047          ww.bytes/1e6); 
0048    fprintf(<span class="string">'EIDORS_CACHE: current priority = %d\n'</span>, <span class="keyword">...</span>
0049          eidors_objects.cache_priority); 
0050    <span class="keyword">return</span>;
0051 <span class="keyword">elseif</span> nargin&gt;=2
0052    <span class="keyword">if</span> ischar(limit); limit= str2num(limit); <span class="keyword">end</span>
0053 <span class="keyword">end</span>
0054 
0055 
0056 
0057 <span class="keyword">switch</span> command
0058    <span class="keyword">case</span> {<span class="string">'clear_all'</span>,<span class="string">'clear'</span>}
0059       [objid, times, sizes, prios, priidx] = get_names_times;
0060       <a href="#_sub2" class="code" title="subfunction remove_objids( objid, sizes, idx)">remove_objids</a>( objid, sizes,  1:length(sizes) );
0061 
0062    <span class="keyword">case</span> <span class="string">'cache_size'</span>
0063       <span class="keyword">if</span> nargin==2
0064          eidors_objects.max_cache_size = limit;
0065       <span class="keyword">else</span>
0066          retval= eidors_objects.max_cache_size;
0067       <span class="keyword">end</span>
0068 
0069    <span class="keyword">case</span> <span class="string">'boost_priority'</span>
0070       <span class="keyword">try</span>
0071          retval= eidors_objects.cache_priority;
0072       <span class="keyword">catch</span>
0073          retval= 0; <span class="comment">% default priority</span>
0074       <span class="keyword">end</span>
0075       <span class="keyword">if</span> nargin==2
0076          retval = retval + limit;
0077       <span class="keyword">end</span>
0078       eidors_objects.cache_priority = retval;
0079 
0080    <span class="keyword">case</span> <span class="string">'show_objs'</span>
0081       [objid, times, sizes, prios, priidx] = get_names_times;
0082       <span class="keyword">for</span> i=1:length(times)
0083          fprintf(<span class="string">'t=%9.7f b=%9.0d p=%02d, i=%03d: %s\n'</span>, rem(times(i),1), <span class="keyword">...</span><span class="comment"> %today</span>
0084              sizes(i), prios(i), priidx(i), objid{i} ); 
0085       <span class="keyword">end</span>
0086 
0087    <span class="keyword">case</span> <span class="string">'clear_max'</span>
0088 <span class="comment">% This will remove just in order of priidx.</span>
0089 <span class="comment">%     remove_objids( objid, sizes,  find(cumsum(sizes) &gt; limit) );</span>
0090 <span class="comment">% Remove in order of time + priority</span>
0091       [objid, times, sizes, prios, priidx] = get_names_times;
0092       tot=     cumsum(sizes(priidx)); 
0093       remove = find(tot &gt; limit);
0094       rmidx=   priidx(remove);
0095       <a href="#_sub2" class="code" title="subfunction remove_objids( objid, sizes, idx)">remove_objids</a>( objid, sizes,  rmidx);
0096 
0097    <span class="keyword">case</span> <span class="string">'clear_old'</span>
0098       [objid, times, sizes, prios, priidx] = get_names_times;
0099       <a href="#_sub2" class="code" title="subfunction remove_objids( objid, sizes, idx)">remove_objids</a>( objid, sizes,  <span class="keyword">...</span>
0100         find(times &lt; limit) );
0101 
0102    <span class="keyword">case</span> <span class="string">'clear_new'</span>
0103       [objid, times, sizes, prios, priidx] = get_names_times;
0104       <a href="#_sub2" class="code" title="subfunction remove_objids( objid, sizes, idx)">remove_objids</a>( objid, sizes,  <span class="keyword">...</span>
0105         find(times &gt; limit) );
0106 
0107    <span class="keyword">case</span> <span class="string">'clear_model_library'</span>
0108       <span class="comment">%TODO: add ways to select what to delete</span>
0109       delete([eidors_objects.model_cache,<span class="string">'/*.mat'</span>]);
0110    
0111    <span class="keyword">otherwise</span>
0112       error(<span class="string">'command %s not understood'</span>,command);
0113 <span class="keyword">end</span>
0114 
0115 <span class="comment">% priidx is priority index, where 1 prio is 0.1 of a day</span>
0116 <a name="_sub1" href="#_subfunctions" class="code">function [objid, times, sizes, prios, priidx] = get_names_times;</a>
0117    objid={}; times=[]; sizes=[]; pri=[]; prios=[]; priidx=[];
0118    <span class="keyword">global</span> eidors_objects;
0119    <span class="keyword">if</span> isempty(eidors_objects); <span class="keyword">return</span>; <span class="keyword">end</span>
0120    idx=1;
0121    <span class="keyword">for</span> fn= fieldnames(eidors_objects)'
0122       fn1= fn{1};
0123       <span class="keyword">if</span> fn1(1:3)== <span class="string">'id_'</span>
0124          objid{idx}= fn1;
0125 
0126          obj = getfield(eidors_objects, fn1 );
0127          <span class="keyword">try</span>
0128             times(idx) = obj.last_used;
0129          <span class="keyword">catch</span>
0130             times(idx) = 0; <span class="comment">% old</span>
0131          <span class="keyword">end</span>
0132          <span class="keyword">try</span>
0133             prios(idx) = obj.priority;
0134          <span class="keyword">catch</span>
0135             prios(idx) = 0; <span class="comment">% default</span>
0136          <span class="keyword">end</span>
0137 
0138          ww= whos(<span class="string">'obj'</span>);
0139          sizes(idx) = ww.bytes;
0140 
0141          idx= idx+1;
0142       <span class="keyword">end</span>
0143    <span class="keyword">end</span>
0144 
0145    <span class="comment">% sort from recent (high) to old (low)</span>
0146    [times, idx] = sort(-times);
0147    times= -times;
0148    objid= objid(idx);
0149    sizes= sizes(idx);
0150    prios= prios(idx);
0151    <span class="comment">% sort from high to low priority and recent (high) to old (low)</span>
0152    [jnk, priidx] = sortrows([-prios(:), -times(:)]);
0153 
0154 <a name="_sub2" href="#_subfunctions" class="code">function remove_objids( objid, sizes, idx)</a>
0155    <span class="keyword">global</span> eidors_objects;
0156    eidors_objects= rmfield( eidors_objects, objid( idx ) );
0157    <a href="eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'eidors_cache: removing %d objects with %d bytes'</span>, <span class="keyword">...</span>
0158           length(idx), sum(sizes(idx)), 3 );</pre></div>
<hr><address>Generated on Wed 13-Jul-2011 23:23:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>