<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of cheating_2d</title>
  <meta name="keywords" content="cheating_2d">
  <meta name="description" content="code to simulate inverse crimes in EIT">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html?eidors/examples/cheating_2d.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html eidors --><!-- menu.html examples -->
<h1>cheating_2d
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>code to simulate inverse crimes in EIT</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function out=cheating_2d( figno, rand_seed ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> code to simulate inverse crimes in EIT</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/algorithms/a_adler/aa_fwd_parameters.html" class="code" title="function param = aa_fwd_parameters( fwd_model )">aa_fwd_parameters</a>	AA_FWD_PARAMETERS: data= aa_fwd_solve( fwd_model, image)</li><li><a href="../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>	EIDORS_OBJ: 'constructor' to create a eidors structure</li><li><a href="../../eidors/fwd_solve.html" class="code" title="function data = fwd_solve( fwd_model, img)">fwd_solve</a>	FWD_SOLVE: calculate data from a fwd_model object and an image</li><li><a href="../../eidors/graphics_matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>	SHOW_FEM: show the EIDORS3D finite element model</li><li><a href="../../eidors/graphics_matlab/show_slices.html" class="code" title="function out_img= show_slices( img, levels )">show_slices</a>	out_img = show_slices (img, levels ) show slices at levels of an</li><li><a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>	INV_SOLVE: calculate imag from an inv_model and data</li><li><a href="../../eidors/models/a_adler/mk_circ_tank.html" class="code" title="function param= mk_circ_tank(rings, levels, elec_spec );">mk_circ_tank</a>	MK_CIRC_TANK: make a cylindrical tank FEM geometry in 2D or 3D</li><li><a href="../../eidors/models/a_adler/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="../../eidors/models/a_adler/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>	MK_STIM_PATTERNS: create an EIDORS stimulation pattern structure</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function approach1(vis, vhs, s_mdl, il_g, rand_seed)</a></li><li><a href="#_sub2" class="code">function approach2a(vis, vhs, s_mdl, il_g)</a></li><li><a href="#_sub3" class="code">function approach2b(vis, vhs, s_mdl, il_g)</a></li><li><a href="#_sub4" class="code">function approach3a(vis, vhs, s_mdl, il_g)</a></li><li><a href="#_sub5" class="code">function approach3b(vis, vhs, s_mdl, il_g)</a></li><li><a href="#_sub6" class="code">function approach4(vis, vhs, s_mdl, il_g, rand_seed)</a></li><li><a href="#_sub7" class="code">function p= small_face;</a></li><li><a href="#_sub8" class="code">function p=large_face</a></li><li><a href="#_sub9" class="code">function [vis,vhs,mdl]= small_2d_mdl</a></li><li><a href="#_sub10" class="code">function i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );</a></li><li><a href="#_sub11" class="code">function reconst_with_noise(i_mdl, vis, vhs, num_tries)</a></li><li><a href="#_sub12" class="code">function Reg= cheat_tikhonov( inv_model )</a></li><li><a href="#_sub13" class="code">function elems= find_adjoin(ee, ELEM)</a></li><li><a href="#_sub14" class="code">function Reg= cheat_laplace( inv_model )</a></li><li><a href="#_sub15" class="code">function mdl1 = angl_deform(mdl0, def_amount );</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% code to simulate inverse crimes in EIT</span>
0002 
0003 <span class="comment">% (C) 2005 Andy Adler. License: GPL version 2 or version 3</span>
0004 <span class="comment">% $Id$</span>
0005 
0006 <span class="comment">%TODO: calculate how well data matches priors</span>
0007 <a name="_sub0" href="#_subfunctions" class="code">function out=cheating_2d( figno, rand_seed )</a>
0008    [vis,vhs,s_mdl]= <a href="#_sub9" class="code" title="subfunction [vis,vhs,mdl]= small_2d_mdl">small_2d_mdl</a>;
0009 
0010    <span class="keyword">if</span> nargin&lt;2; rand_seed= []; <span class="keyword">end</span>
0011 
0012    il_g = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>( 12 ); <span class="comment">%large model</span>
0013 
0014    <span class="keyword">if</span> nargin==0; figno= {<span class="string">'1'</span>,<span class="string">'2a'</span>,<span class="string">'2b'</span>,<span class="string">'3a'</span>,<span class="string">'3b'</span>,<span class="string">'4'</span>}; <span class="keyword">end</span> 
0015    <span class="keyword">if</span> isstr(figno); figno= {figno}; <span class="keyword">end</span>
0016 
0017    <span class="keyword">for</span> idx= 1:length(figno)
0018        <span class="keyword">if</span> idx~=1; pause; <span class="keyword">end</span>
0019 
0020        <span class="keyword">if</span>     strcmp( figno{idx}, <span class="string">'1'</span> )
0021            <a href="#_sub1" class="code" title="subfunction approach1(vis, vhs, s_mdl, il_g, rand_seed)">approach1</a>(vis, vhs, s_mdl, il_g, rand_seed)
0022        <span class="keyword">elseif</span> strcmp( figno{idx}, <span class="string">'2a'</span> )
0023            <a href="#_sub2" class="code" title="subfunction approach2a(vis, vhs, s_mdl, il_g)">approach2a</a>(vis, vhs, s_mdl, il_g)
0024        <span class="keyword">elseif</span> strcmp( figno{idx}, <span class="string">'2b'</span> )
0025            <a href="#_sub3" class="code" title="subfunction approach2b(vis, vhs, s_mdl, il_g)">approach2b</a>(vis, vhs, s_mdl, il_g)
0026        <span class="keyword">elseif</span> strcmp( figno{idx}, <span class="string">'3a'</span> )
0027            <a href="#_sub4" class="code" title="subfunction approach3a(vis, vhs, s_mdl, il_g)">approach3a</a>(vis, vhs, s_mdl, il_g)
0028        <span class="keyword">elseif</span> strcmp( figno{idx}, <span class="string">'3b'</span> )
0029            <a href="#_sub5" class="code" title="subfunction approach3b(vis, vhs, s_mdl, il_g)">approach3b</a>(vis, vhs, s_mdl, il_g)
0030        <span class="keyword">elseif</span> strcmp( figno{idx}, <span class="string">'4'</span> )
0031            <a href="#_sub6" class="code" title="subfunction approach4(vis, vhs, s_mdl, il_g, rand_seed)">approach4</a>(vis, vhs, s_mdl, il_g, rand_seed)
0032        <span class="keyword">elseif</span> strcmp( figno{idx}, <span class="string">'4b'</span> )
0033        mdl= <a href="../../eidors/models/a_adler/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'b2c'</span>);
0034            <span class="keyword">if</span> ~isempty(rand_seed); randn(<span class="string">'state'</span>, rand_seed(i)); <span class="keyword">end</span>
0035            def_mdl = <a href="../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'fwd_model'</span>, <a href="#_sub15" class="code" title="subfunction mdl1 = angl_deform(mdl0, def_amount );">angl_deform</a>(mdl.fwd_model, .02));
0036        <a href="../../eidors/graphics_matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(def_mdl);
0037        <span class="keyword">end</span>
0038    <span class="keyword">end</span>
0039 <span class="comment">%</span>
0040 <span class="comment">% APPROACH 1</span>
0041 <span class="comment">%</span>
0042 <a name="_sub1" href="#_subfunctions" class="code">function approach1(vis, vhs, s_mdl, il_g, rand_seed)</a>
0043    disp(<span class="string">'Approach #1: reconstruct with noise'</span>);
0044 
0045    num_tries=6;
0046    levels= [];
0047    <span class="keyword">if</span> ~isempty(rand_seed);
0048       num_tries= length(rand_seed);
0049       levels= [0,0,0,1,1];
0050    <span class="keyword">end</span>
0051 
0052    vi_n(1:num_tries) = vis;
0053    <span class="keyword">for</span> i= 1:num_tries <span class="comment">% stupid matlab doesn't allow easy vectorization</span>
0054       <span class="keyword">if</span> ~isempty(rand_seed); randn(<span class="string">'state'</span>, rand_seed(i)); <span class="keyword">end</span>
0055       noise = .0002*randn(size(vis.meas));
0056       vi_n(i).meas = vi_n(i).meas + noise;
0057    <span class="keyword">end</span>
0058    <a href="../../eidors/graphics_matlab/show_slices.html" class="code" title="function out_img= show_slices( img, levels )">show_slices</a>( <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( il_g, vhs, vi_n ), levels);
0059 
0060 
0061 <span class="comment">%</span>
0062 <span class="comment">% APPROACH 2A</span>
0063 <span class="comment">%</span>
0064 <a name="_sub2" href="#_subfunctions" class="code">function approach2a(vis, vhs, s_mdl, il_g)</a>
0065    levels= [0,0,0,1,1];
0066    disp(<span class="string">'Approach #2: reconstruct with tikhonov cheat - with inv crime'</span>);
0067    pp= small_face;
0068    <span class="comment">% homog (normal) model</span>
0069    RtR_prior= @<a href="#_sub12" class="code" title="subfunction Reg= cheat_tikhonov( inv_model )">cheat_tikhonov</a>;
0070    param_vals.cheat_elements= [];
0071    param_vals.cheat_weight = 0.5;
0072    is_n = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>( 8 , RtR_prior, <span class="string">'cheat_tikhonov'</span>, param_vals ); 
0073    <span class="comment">% sad model</span>
0074    param_vals.cheat_elements= [pp.eyes, pp.sad];
0075    is_s = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>( 8 , RtR_prior, <span class="string">'cheat_tikhonov'</span>, param_vals ); 
0076    <span class="comment">% happy model</span>
0077    param_vals.cheat_elements= [pp.eyes, pp.smile];
0078    is_h = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>( 8 , RtR_prior, <span class="string">'cheat_tikhonov'</span>, param_vals ); 
0079    <span class="comment">% happy/sad (medium) model</span>
0080    param_vals.cheat_elements= [pp.eyes, pp.rsmile, pp.lsad];
0081    is_m = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>( 8 , RtR_prior, <span class="string">'cheat_tikhonov'</span>, param_vals ); 
0082 
0083    <a href="../../eidors/graphics_matlab/show_slices.html" class="code" title="function out_img= show_slices( img, levels )">show_slices</a>( [ <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( is_n, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0084                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( is_s, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0085                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( is_h, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0086                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( is_m, vhs, vis ) ], levels );
0087 
0088 
0089 
0090 <span class="comment">%</span>
0091 <span class="comment">% APPROACH 2B</span>
0092 <span class="comment">%</span>
0093 <a name="_sub3" href="#_subfunctions" class="code">function approach2b(vis, vhs, s_mdl, il_g)</a>
0094    disp(<span class="string">'Approach #2B: reconstruct with tikhonov cheat - without inv crime'</span>);
0095    levels= [0,0,0,1,1];
0096    pp= <a href="#_sub8" class="code" title="subfunction p=large_face">large_face</a>;
0097    <span class="comment">% homog (normal) model</span>
0098    RtR_prior= @<a href="#_sub12" class="code" title="subfunction Reg= cheat_tikhonov( inv_model )">cheat_tikhonov</a>;
0099    param_vals.cheat_elements= [];
0100    param_vals.cheat_weight = 0.5;
0101    il_n = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>(12 , RtR_prior, <span class="string">'cheat_tikhonov'</span>, param_vals ); 
0102    <span class="comment">% sad model</span>
0103    param_vals.cheat_elements= pp.sad;
0104    il_s = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>(12 , RtR_prior, <span class="string">'cheat_tikhonov'</span>, param_vals ); 
0105    <span class="comment">% happy model</span>
0106    param_vals.cheat_elements= pp.happy;
0107    il_h = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>(12 , RtR_prior, <span class="string">'cheat_tikhonov'</span>, param_vals ); 
0108    <span class="comment">% happy/sad (medium) model</span>
0109    param_vals.cheat_elements= pp.halfy;
0110    il_m = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>(12 , RtR_prior, <span class="string">'cheat_tikhonov'</span>, param_vals ); 
0111 
0112    <a href="../../eidors/graphics_matlab/show_slices.html" class="code" title="function out_img= show_slices( img, levels )">show_slices</a>( [ <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( il_n, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0113                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( il_s, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0114                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( il_h, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0115                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( il_m, vhs, vis ) ], levels );
0116 
0117 <span class="comment">%</span>
0118 <span class="comment">% APPROACH 3A</span>
0119 <span class="comment">%</span>
0120 <a name="_sub4" href="#_subfunctions" class="code">function approach3a(vis, vhs, s_mdl, il_g)</a>
0121    disp(<span class="string">'Approach #3: reconstruct with Laplace filter cheat - with inv crime'</span>);
0122    levels= [0,0,0,1,1];
0123    pp= small_face;
0124    <span class="comment">% homog (normal) model</span>
0125    RtR_prior= @<a href="#_sub14" class="code" title="subfunction Reg= cheat_laplace( inv_model )">cheat_laplace</a>;
0126    param_vals.cheat_elements= [];
0127    param_vals.cheat_weight = 0.2;
0128    is_n = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>( 8 , RtR_prior, <span class="string">'cheat_laplace'</span>, param_vals ); 
0129    <span class="comment">% sad model</span>
0130    param_vals.cheat_elements= [pp.eyes, pp.sad];
0131    is_s = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>( 8 , RtR_prior, <span class="string">'cheat_laplace'</span>, param_vals ); 
0132    <span class="comment">% happy model</span>
0133    param_vals.cheat_elements= [pp.eyes, pp.smile];
0134    is_h = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>( 8 , RtR_prior, <span class="string">'cheat_laplace'</span>, param_vals ); 
0135    <span class="comment">% happy/sad (medium) model</span>
0136    param_vals.cheat_elements= [pp.eyes, pp.rsmile, pp.lsad];
0137    is_m = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>( 8 , RtR_prior, <span class="string">'cheat_laplace'</span>, param_vals ); 
0138 
0139    <a href="../../eidors/graphics_matlab/show_slices.html" class="code" title="function out_img= show_slices( img, levels )">show_slices</a>( [ <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( is_n, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0140                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( is_s, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0141                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( is_h, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0142                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( is_m, vhs, vis ) ], levels );
0143 
0144 
0145 <span class="comment">%</span>
0146 <span class="comment">% APPROACH 3B</span>
0147 <span class="comment">%</span>
0148 <a name="_sub5" href="#_subfunctions" class="code">function approach3b(vis, vhs, s_mdl, il_g)</a>
0149    disp(<span class="string">'Approach #3B: reconstruct with Laplace cheat - without inv crime'</span>);
0150    levels= [0,0,0,1,1];
0151    pp= <a href="#_sub8" class="code" title="subfunction p=large_face">large_face</a>;
0152    <span class="comment">% homog (normal) model</span>
0153    RtR_prior= @<a href="#_sub14" class="code" title="subfunction Reg= cheat_laplace( inv_model )">cheat_laplace</a>;
0154    param_vals.cheat_elements= [];
0155    param_vals.cheat_weight = 0.2;
0156    il_n = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>(12 , RtR_prior, <span class="string">'cheat_laplace'</span>, param_vals ); 
0157    <span class="comment">% sad model</span>
0158    param_vals.cheat_elements= pp.sad;
0159    il_s = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>(12 , RtR_prior, <span class="string">'cheat_laplace'</span>, param_vals ); 
0160    <span class="comment">% happy model</span>
0161    param_vals.cheat_elements= pp.happy;
0162    il_h = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>(12 , RtR_prior, <span class="string">'cheat_laplace'</span>, param_vals ); 
0163    <span class="comment">% happy/sad (medium) model</span>
0164    param_vals.cheat_elements= pp.halfy;
0165    il_m = <a href="#_sub10" class="code" title="subfunction i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );">make_inv_model</a>(12 , RtR_prior, <span class="string">'cheat_laplace'</span>, param_vals ); 
0166 
0167    <a href="../../eidors/graphics_matlab/show_slices.html" class="code" title="function out_img= show_slices( img, levels )">show_slices</a>( [ <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( il_n, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0168                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( il_s, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0169                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( il_h, vhs, vis ), <span class="keyword">...</span><span class="comment"> </span>
0170                   <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( il_m, vhs, vis ) ], levels );
0171 
0172 
0173 <span class="comment">%</span>
0174 <span class="comment">% APPROACH 4</span>
0175 <span class="comment">%</span>
0176 <a name="_sub6" href="#_subfunctions" class="code">function approach4(vis, vhs, s_mdl, il_g, rand_seed)</a>
0177    disp(<span class="string">'Approach #4: deform the model'</span>);
0178    num_tries=6;
0179    levels= [];
0180    <span class="keyword">if</span> ~isempty(rand_seed);
0181       num_tries= length(rand_seed);
0182       levels= [0,0,0,1,1];
0183    <span class="keyword">end</span>
0184 
0185    params= <a href="../../eidors/models/a_adler/mk_circ_tank.html" class="code" title="function param= mk_circ_tank(rings, levels, elec_spec );">mk_circ_tank</a>(8, [], 16 ); 
0186    params.stimulation= <a href="../../eidors/models/a_adler/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(16, 1, <span class="string">'{ad}'</span>,<span class="string">'{ad}'</span>, <span class="keyword">...</span>
0187                          {<span class="string">'no_meas_current'</span>,<span class="string">'no_rotate_meas'</span>}, 1);
0188    params.solve=      <span class="string">'aa_fwd_solve'</span>;
0189    params.system_mat= <span class="string">'aa_calc_system_mat'</span>;
0190 
0191    mat= ones( size(params.elems,1), 1);
0192    pp= small_face;
0193    mat(pp.eyes)= 2;
0194    mat(pp.sad)=1.5;
0195 
0196    def_amount= .0035;
0197 
0198    <span class="keyword">for</span> i= 1:num_tries <span class="comment">% stupid matlab doesn't allow easy vectorization</span>
0199       <span class="keyword">if</span> ~isempty(rand_seed); randn(<span class="string">'state'</span>, rand_seed(i)); <span class="keyword">end</span>
0200 
0201       def_mdl = <a href="../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'fwd_model'</span>, <a href="#_sub15" class="code" title="subfunction mdl1 = angl_deform(mdl0, def_amount );">angl_deform</a>(params, def_amount ) );
0202       vi_m(i)= <a href="../../eidors/fwd_solve.html" class="code" title="function data = fwd_solve( fwd_model, img)">fwd_solve</a>( <a href="../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'image'</span>,<span class="string">'name'</span>,  <span class="keyword">...</span>
0203                      <span class="string">'elem_data'</span>, mat, <span class="string">'fwd_model'</span>, def_mdl ));
0204    <span class="keyword">end</span>
0205    <a href="../../eidors/graphics_matlab/show_slices.html" class="code" title="function out_img= show_slices( img, levels )">show_slices</a>( <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( il_g, vhs, vi_m ), levels);
0206 
0207 
0208 
0209    
0210 <span class="keyword">return</span>;
0211 
0212 <a name="_sub7" href="#_subfunctions" class="code">function p= small_face;</a>
0213    p.leye=   [78,97,98,117,118,141];
0214    p.reye=   [66,82,83,102,103,123];
0215    p.rsmile= [40:41, 53:55, 69:71, 86:88];
0216    p.lsmile= [43:44, 57:59, 73:75, 91:93];
0217    p.lsad =  [31,43,58,57,74,73,92,93,113,112,135];
0218    p.sad =   [28,31,40,43,58,57,53,54,74,73,92,93,113, <span class="keyword">...</span>
0219               112,135,69,87,70,107,88,108,129];
0220    p.eyes= [p.leye,p.reye];
0221    p.smile= [p.rsmile, p.lsmile];
0222 
0223 <a name="_sub8" href="#_subfunctions" class="code">function p=large_face</a>
0224 p.sad=  [ 53; 57; 69; 73; 86; 87; 91; 92; 106; 107; 111; 112; 127; 128;
0225          129; 133; 134; 135; 147; 151; 152; 153; 157; 158; 159; 165;
0226          171; 172; 177; 178; 179; 184; 185; 186; 192; 193; 199; 200;
0227          205; 206; 207; 212; 213; 214; 220; 221; 227; 228; 229; 235;
0228          236; 243; 244; 251; 252; 253; 259; 260; 261; 267; 268; 275;
0229          276; 283; 284; 285; 292; 293; 301; 310; 319; 320]; 
0230 
0231 p.happy= [ <span class="keyword">...</span>
0232         69; 70; 71; 73; 74; 75; 86; 87; 88; 89; 91; 92; 93; 94; 106;
0233        107; 108; 109; 111; 112; 113; 114; 127; 128; 129; 130; 131; 133;
0234        134; 135; 136; 137; 147; 151; 152; 153; 154; 155; 157; 158; 159;
0235        160; 161; 165; 171; 172; 176; 177; 178; 179; 180; 183; 184; 185;
0236        186; 187; 192; 193; 199; 200; 220; 221; 227; 228; 229; 251; 252;
0237        253; 259; 260; 261; 283; 284; 285; 292; 293; 319; 320]; 
0238 
0239 p.halfy= [ <span class="keyword">...</span>
0240         57; 69; 70; 71; 73; 86; 87; 88; 89; 91; 92; 106; 107; 108; 109;
0241        111; 112; 127; 128; 129; 130; 131; 133; 134; 135; 147; 151; 152;
0242        153; 154; 155; 157; 158; 159; 165; 171; 172; 176; 177; 178; 179;
0243        180; 184; 185; 186; 192; 193; 199; 200; 212; 213; 214; 220; 221;
0244        227; 228; 229; 243; 244; 251; 252; 253; 259; 260; 261; 275; 276;
0245        283; 284; 285; 292; 293; 310; 319; 320];
0246 
0247 <span class="comment">% simulate 'sad' data for small model</span>
0248 <a name="_sub9" href="#_subfunctions" class="code">function [vis,vhs,mdl]= small_2d_mdl</a>
0249    params= <a href="../../eidors/models/a_adler/mk_circ_tank.html" class="code" title="function param= mk_circ_tank(rings, levels, elec_spec );">mk_circ_tank</a>(8, [], 16 ); 
0250    params.stimulation= <a href="../../eidors/models/a_adler/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(16, 1, <span class="string">'{ad}'</span>,<span class="string">'{ad}'</span>, <span class="keyword">...</span>
0251                          {<span class="string">'no_meas_current'</span>,<span class="string">'no_rotate_meas'</span>}, 1);
0252    params.solve=      <span class="string">'aa_fwd_solve'</span>;
0253    params.system_mat= <span class="string">'aa_calc_system_mat'</span>;
0254    mdl= <a href="../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'fwd_model'</span>, params);
0255 
0256    mat= ones( size(mdl.elems,1), 1);
0257 
0258    <span class="comment">% homogeneous data</span>
0259    vhs= <a href="../../eidors/fwd_solve.html" class="code" title="function data = fwd_solve( fwd_model, img)">fwd_solve</a>( <a href="../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'image'</span>,<span class="string">'name'</span>,  <span class="keyword">...</span>
0260                      <span class="string">'elem_data'</span>, mat, <span class="string">'fwd_model'</span>, mdl ));
0261 
0262    <span class="comment">% inhomogeneous data for sad face model</span>
0263    pp= small_face;
0264    mat(pp.eyes)= 2;
0265    mat(pp.sad)=1.5;
0266 
0267    vis= <a href="../../eidors/fwd_solve.html" class="code" title="function data = fwd_solve( fwd_model, img)">fwd_solve</a>( <a href="../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'image'</span>,<span class="string">'name'</span>,  <span class="keyword">...</span>
0268                      <span class="string">'elem_data'</span>, mat, <span class="string">'fwd_model'</span>, mdl ));
0269 
0270 <span class="comment">% create inv_model, and specify img_prior if required</span>
0271 <a name="_sub10" href="#_subfunctions" class="code">function i_mdl= make_inv_model( n_rings, img_prior, param_name, param_vals );</a>
0272    params= <a href="../../eidors/models/a_adler/mk_circ_tank.html" class="code" title="function param= mk_circ_tank(rings, levels, elec_spec );">mk_circ_tank</a>(n_rings, [], 16 ); 
0273    params.stimulation= <a href="../../eidors/models/a_adler/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(16, 1, <span class="string">'{ad}'</span>,<span class="string">'{ad}'</span>, <span class="keyword">...</span>
0274                          {<span class="string">'no_meas_current'</span>,<span class="string">'no_rotate_meas'</span>}, 1);
0275    params.solve=      <span class="string">'aa_fwd_solve'</span>;
0276    params.system_mat= <span class="string">'aa_calc_system_mat'</span>;
0277    params.jacobian  = <span class="string">'aa_calc_jacobian'</span>;
0278 <span class="comment">%  params.normalize_measurements  = 1; TODO: we have a bug here</span>
0279    l_mdl= <a href="../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'fwd_model'</span>, params);
0280 
0281 <span class="comment">% create inverse model</span>
0282    hparam.value = 3e-4;
0283   <span class="comment">%hparam.func = 'select_noise_figure';</span>
0284   <span class="comment">%hparam.noise_figure= 1;</span>
0285   <span class="comment">%hparam.tgt_elems= 1:4;</span>
0286 
0287    <span class="keyword">if</span> nargin &lt; 2
0288       img_prior = <span class="string">'tikhonov_image_prior'</span>;
0289       param_name= <span class="string">'jnk___'</span>; param_vals= <span class="string">'jnk___'</span>;
0290    <span class="keyword">end</span>
0291 
0292    i_mdl= <a href="../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>( <span class="keyword">...</span>
0293           <span class="string">'inv_model'</span>, <span class="string">'2D inverse'</span>, <span class="keyword">...</span>
0294           <span class="string">'hyperparameter'</span>, hparam, <span class="string">'RtR_prior'</span>, img_prior, <span class="keyword">...</span>
0295           param_name, param_vals, <span class="keyword">...</span>
0296           <span class="string">'reconst_type'</span>, <span class="string">'difference'</span>, <span class="keyword">...</span>
0297           <span class="string">'fwd_model'</span>, l_mdl, <span class="string">'solve'</span>, <span class="string">'aa_inv_solve'</span> );
0298    i_mdl.jacobian_bkgnd.value= 1;
0299 
0300 
0301 <a name="_sub11" href="#_subfunctions" class="code">function reconst_with_noise(i_mdl, vis, vhs, num_tries)</a>
0302     noise = .0002*randn(size(vis.meas,1),num_tries);
0303 
0304     vi_n(1:num_tries) = vis;
0305     <span class="keyword">for</span> i= 1:num_tries <span class="comment">% stupid matlab doesn't allow easy vectorization</span>
0306        vi_n(i).meas = vi_n(i).meas + noise(:,i);
0307     <span class="keyword">end</span>
0308     <a href="../../eidors/graphics_matlab/show_slices.html" class="code" title="function out_img= show_slices( img, levels )">show_slices</a>( <a href="../../eidors/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( i_mdl, vhd, vi_n ));
0309 
0310 <span class="comment">% Image prior with Tikhonov + cheating elements</span>
0311 <a name="_sub12" href="#_subfunctions" class="code">function Reg= cheat_tikhonov( inv_model )</a>
0312 <span class="comment">% Reg= cheat_tikhonov( inv_model )</span>
0313 <span class="comment">% Reg        =&gt; output regularization term</span>
0314 <span class="comment">% Parameters:</span>
0315 <span class="comment">%   elems    = inv_model.RtR_prior.cheat_elements;</span>
0316 <span class="comment">%            =&gt; elements weights to modify</span>
0317 <span class="comment">%   weight   = inv_model.RtR_prior.cheat_weight;</span>
0318 <span class="comment">%            =&gt; new weight to set elements to</span>
0319 
0320 
0321 pp= <a href="../../eidors/algorithms/a_adler/aa_fwd_parameters.html" class="code" title="function param = aa_fwd_parameters( fwd_model )">aa_fwd_parameters</a>( inv_model.fwd_model );
0322 idx= 1:pp.n_elem;
0323 weight= ones(1,pp.n_elem);
0324 weight( inv_model.cheat_tikhonov.cheat_elements ) = <span class="keyword">...</span>
0325         inv_model.cheat_tikhonov.cheat_weight;
0326 
0327 Reg = sparse( idx, idx, weight );
0328 
0329 <span class="comment">% find elems which are connected to elems ee</span>
0330 <a name="_sub13" href="#_subfunctions" class="code">function elems= find_adjoin(ee, ELEM)</a>
0331    nn= ELEM(:,ee);
0332    [d,e]= size(ELEM);
0333    ss= zeros(1,e);
0334    <span class="keyword">for</span> i=1:d
0335      ss= ss+ any(ELEM==nn(i));
0336    <span class="keyword">end</span>
0337    elems= find(ss==d-1);
0338 
0339 <span class="comment">% Image prior with FEM based Laplacian + cheating</span>
0340 <a name="_sub14" href="#_subfunctions" class="code">function Reg= cheat_laplace( inv_model )</a>
0341 <span class="comment">% Reg= cheat_laplace( inv_model )</span>
0342 <span class="comment">% Reg        =&gt; output regularization term</span>
0343 <span class="comment">% Parameters:</span>
0344 <span class="comment">%   elems    = inv_model.RtR_prior.cheat_elements;</span>
0345 <span class="comment">%            =&gt; elements weights to modify</span>
0346 <span class="comment">%   weight   = inv_model.RtR_prior.cheat_weight;</span>
0347 <span class="comment">%            =&gt; new weight to set elements to</span>
0348 
0349 <span class="comment">% make pseudo laplacian filter</span>
0350 <span class="comment">%   roielems = region to exclude boundary</span>
0351 <span class="comment">%   if both ii and jj are in or out of roielems</span>
0352 <span class="comment">%   then include the term</span>
0353    pp= <a href="../../eidors/algorithms/a_adler/aa_fwd_parameters.html" class="code" title="function param = aa_fwd_parameters( fwd_model )">aa_fwd_parameters</a>( inv_model.fwd_model );
0354 
0355    ROI = zeros(1,pp.n_elem);
0356    ROI( inv_model.cheat_laplace.cheat_elements ) = 1;
0357 
0358    Iidx= [];
0359    Jidx= [];
0360    Vidx= [];
0361    <span class="keyword">for</span> ii=1:pp.n_elem
0362      el_adj = <a href="#_sub13" class="code" title="subfunction elems= find_adjoin(ee, ELEM)">find_adjoin</a>( ii, pp.ELEM );
0363      <span class="keyword">for</span> jj=el_adj(:)'
0364          <span class="keyword">if</span> (ROI(ii) + ROI(jj)) == 1 <span class="comment">%one only</span>
0365             fac= inv_model.cheat_laplace.cheat_weight *.5;
0366          <span class="keyword">else</span> 
0367             fac = .5;
0368          <span class="keyword">end</span>
0369          Iidx= [Iidx,      ii, ii, jj, jj];
0370          Jidx= [Jidx,      ii, jj, ii, jj];
0371          Vidx= [Vidx, fac*([1, -1, -1,  1]) ];
0372      <span class="keyword">end</span>
0373    <span class="keyword">end</span>
0374    Reg = sparse(Iidx,Jidx, Vidx, pp.n_elem, pp.n_elem );
0375 
0376 <span class="comment">% deform a model by Delta</span>
0377 <span class="comment">% A1 = A0 + k1*sin(A0) + k2*cos(A0) + k3*sin(2*A0) ...</span>
0378 <a name="_sub15" href="#_subfunctions" class="code">function mdl1 = angl_deform(mdl0, def_amount );</a>
0379 
0380    node0= mdl0.nodes';
0381    deform = def_amount*(8:-1:1).*randn(1,8);
0382 
0383    A0 = atan2( node0(2,:), node0(1,:) );
0384    R0 = sqrt( sum( node0.^2 ));
0385    A1= A0;
0386    <span class="keyword">for</span> k= 2:2:length(deform)
0387       m = k/2;
0388       A1= A1 + deform(k-1)*cos(m*A0) + deform(k)*sin(m*A0);
0389    <span class="keyword">end</span>
0390    node1 = [R0.*cos(A1); R0.*sin(A1) ];
0391 
0392    mdl1 = mdl0;
0393    mdl1.nodes = node1';
0394</pre></div>
<hr><address>Generated on Tue 09-Aug-2011 11:38:31 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>