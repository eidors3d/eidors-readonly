<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of deform_cylinder</title>
  <meta name="keywords" content="deform_cylinder">
  <meta name="description" content="fwd_mdl = deform_cylinder( fwd_mdl, niv);">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html?eidors/models/a_adler/deform_cylinder.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html eidors --><!-- # models --><!-- menu.html a_adler -->
<h1>deform_cylinder
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>fwd_mdl = deform_cylinder( fwd_mdl, niv);</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function fwd_mdl = deform_cylinder( fwd_mdl, geo); </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> fwd_mdl = deform_cylinder( fwd_mdl, niv);
 Deform the boundary of the cylinder to make it like a torso
 niv= 1.. 5 =&gt; Torso shape from T5 - T12
 xyz_expand - rescale xyz - default should be [1];</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/graphics_matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>	SHOW_FEM: show the EIDORS3D finite element model</li><li><a href="../../../eidors/meshing/netgen/ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>	NG_MAKE_CYL_MODELS: create cylindrical models using netgen</li><li><a href="deform_cylinder.html" class="code" title="function fwd_mdl = deform_cylinder( fwd_mdl, geo);">deform_cylinder</a>	fwd_mdl = deform_cylinder( fwd_mdl, niv);</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="deform_cylinder.html" class="code" title="function fwd_mdl = deform_cylinder( fwd_mdl, geo);">deform_cylinder</a>	fwd_mdl = deform_cylinder( fwd_mdl, niv);</li><li><a href="thorax_geometry.html" class="code" title="function [out1, out2, out3 ] = thorax_geometry(in1,in2);">thorax_geometry</a>	THORAX_GEOMETRY: deform mesh to have a human thorax like shape</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function fmdl_out = deform_cylinder2( fmdl, deform_pararms)</a></li><li><a href="#_sub2" class="code">function pp = proc_params( deform_pararms, fmdl )</a></li><li><a href="#_sub3" class="code">function deform(fmdl, pp);</a></li><li><a href="#_sub4" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function fwd_mdl = deform_cylinder( fwd_mdl, geo);</a>
0002 <span class="comment">% fwd_mdl = deform_cylinder( fwd_mdl, niv);</span>
0003 <span class="comment">% Deform the boundary of the cylinder to make it like a torso</span>
0004 <span class="comment">% niv= 1.. 5 =&gt; Torso shape from T5 - T12</span>
0005 <span class="comment">% xyz_expand - rescale xyz - default should be [1];</span>
0006 
0007 <span class="keyword">if</span> isstr(fwd_mdl) &amp;&amp; strcmp(fwd_mdl,<span class="string">'UNIT_TEST'</span>); <a href="#_sub4" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0008 
0009     NODE= fwd_mdl.nodes';
0010     a_max= size(geo.xy,1);
0011     ab_geo=sqrt(sum(([ geo.xy; geo.xy(1,:) ]').^2)');
0012     nn= zeros(size(NODE));
0013     <span class="keyword">for</span> i=1:size(NODE,2);
0014       angle = rem(a_max*atan2( NODE(2,i), <span class="keyword">...</span>
0015             NODE(1,i) )/2/pi+a_max,a_max)+1;
0016       fl_angl = floor(angle + eps );
0017       fac=(  (fl_angl + 1 - angle) * ab_geo(fl_angl) + <span class="keyword">...</span>
0018              (angle - fl_angl)     * ab_geo(fl_angl + 1)  );
0019       nn(1:2,i)= NODE(1:2,i)* fac;
0020     <span class="keyword">end</span>  <span class="comment">%for i=1:size</span>
0021     <span class="keyword">if</span> size(nn,1) == 3;
0022        nn(3,:) = NODE(3,:)*geo.z_mag;
0023     <span class="keyword">end</span>
0024 
0025     xyz_expand = 1;
0026     fwd_mdl.nodes = nn'*eye(xyz_expand);
0027 
0028 <a name="_sub1" href="#_subfunctions" class="code">function fmdl_out = deform_cylinder2( fmdl, deform_pararms)</a>
0029 <span class="comment">% fmdl_out = deform_cylinder( fmdl_in, deform_pararms)</span>
0030 <span class="comment">% DEFORM_CYLINDER: deform cylinder from circle to</span>
0031 <span class="comment">%   nearly circular shape. Need to be a bit careful,</span>
0032 <span class="comment">%   because too much deformation will make for poorly</span>
0033 <span class="comment">%   shaped FEM elements.</span>
0034 <span class="comment">%</span>
0035 <span class="comment">% fmdl_out = output (deformed) fmdl</span>
0036 <span class="comment">% fmdl_in  = input (non-deformed) fmdl</span>
0037 <span class="comment">%</span>
0038 <span class="comment">% deform_params values</span>
0039 <span class="comment">%    .axes (rotate axes before and after deform)</span>
0040 <span class="comment">%       deformation is in x,y axis</span>
0041 <span class="comment">%       either as vector [1,3,2] or 2x2 (2D) or 3x3 mat</span>
0042 <span class="comment">%       Default = [1,2,3]</span>
0043 <span class="comment">%    .mode    = 'add' = add deformation</span>
0044 <span class="comment">%               'mul' = multiply by deformation</span>
0045 <span class="comment">%    .xycentre  = [xctr, yctr] (DEFAULT = 0,0)</span>
0046 <span class="comment">%</span>
0047 <span class="comment">%    .xyspecpos = [xelec, yelec]</span>
0048 <span class="comment">%         specified new electrode positions</span>
0049 <span class="comment">%</span>
0050 <span class="comment">%    .zerorad = radius at which deform goes to zero</span>
0051 <span class="comment">%        NOT IMPLEMENTED YET</span>
0052 
0053 <span class="keyword">if</span> isstr(fmdl) &amp;&amp; strcmp(fmdl,<span class="string">'UNIT_TEST'</span>); <a href="#_sub4" class="code" title="subfunction do_unit_test">do_unit_test</a>;<span class="keyword">return</span>;<span class="keyword">end</span>
0054 
0055 pp = <a href="#_sub2" class="code" title="subfunction pp = proc_params( deform_pararms, fmdl )">proc_params</a>( deform_pararms, fmdl )
0056 
0057 <a name="_sub2" href="#_subfunctions" class="code">function pp = proc_params( deform_pararms, fmdl )</a>
0058    d = size(fmdl.nodes,2);
0059    <span class="keyword">if</span> isfield(deform_pararms,<span class="string">'axes'</span>)
0060      dpax = deform_pararms.axes;
0061      [r,c] = size(dpax);
0062      <span class="keyword">if</span> r==1;
0063         pp.axes = sparse(dpax,1:c,1,c,c); 
0064      <span class="keyword">else</span> 
0065         pp.axes = sparse(dpax);
0066 
0067      <span class="keyword">end</span>
0068    <span class="keyword">else</span> 
0069      pp.axes = speye(d);
0070    <span class="keyword">end</span>
0071 
0072    <span class="keyword">if</span> isfield(deform_pararms,<span class="string">'mode'</span>)
0073      <span class="keyword">switch</span> deform_pararms.mode
0074         <span class="keyword">case</span> <span class="string">'add'</span>; pp.mode = 1;
0075         <span class="keyword">case</span> <span class="string">'mul'</span>; pp.mode = 2;
0076         <span class="keyword">otherwise</span>; error([<span class="string">'deform mode not understood'</span>]);
0077      <span class="keyword">end</span>
0078    <span class="keyword">else</span>
0079      pp.mode = 2;
0080    <span class="keyword">end</span>
0081 
0082    <span class="keyword">if</span> isfield(deform_params,<span class="string">'xycentre'</span>)
0083      pp.xctr = deform_pararms.xycentre(1);
0084      pp.yctr = deform_pararms.xycentre(2);
0085    <span class="keyword">else</span>
0086      pp.xctr = 0;
0087      pp.yctr = 0;
0088    <span class="keyword">end</span>
0089 
0090    <span class="comment">% deform_pararms.xyspecpos must be given</span>
0091    xy= deform_pararms.xyspecpos;
0092   [pp.th_s,pp.r_s] = cart2pol(xy(:,1)-pp.xctr, <span class="keyword">...</span>
0093                               xy(:,2)-pp.yctr);
0094    
0095    <span class="comment">% Find rad, theta of electrodes</span>
0096    <span class="keyword">for</span> i=1:length(fmdl.electrode);
0097       enodes = fmdl.electrode(i).nodes;
0098       fepos(i,:) = mean(fmdl.nodes(enodes,:),1);
0099    <span class="keyword">end</span>
0100 
0101   [pp.th_e,pp.r_e] = cart2pol(fepos(:,1)-pp.xctr, <span class="keyword">...</span>
0102                               fepos(:,2)-pp.yctr);
0103 
0104 <a name="_sub3" href="#_subfunctions" class="code">function deform(fmdl, pp);</a>
0105 th = mean([the,thm],2);
0106 dr = re-rm;
0107 dr = [dr;dr;dr];
0108 th = [th-2*pi;th;th+2*pi];
0109 [th,idx]=sort(th); dr= dr(idx);
0110 tpf = polyfit(th,idx,10);
0111 plot(th,dr,<span class="string">'*'</span>);
0112 
0113 [thn,rn] = cart2pol( fmdl.nodes(:,2)-yc, fmdl.nodes(:,3)-zc ); 
0114 drn = interp1(th,dr,thn);
0115 rn = rn + drn;
0116 [nodesy, nodesz] = pol2cart(thn,rn);
0117 fmdl.nodes(:,2:3) = [nodesy+yc, nodesz+zc];
0118 
0119 hh=plot(elec_pos(:,2),elec_pos(:,3),<span class="string">'*-'</span>,fepos(:,2),fepos(:,3),<span class="string">'o-'</span>);
0120 set(hh,<span class="string">'LineWidth'</span>,2);
0121 hold on;
0122 f1ml = fmdl; f1ml.nodes = f1ml.nodes(:,[2,3,1]);
0123 <a href="../../../eidors/graphics_matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(f1ml);
0124 hold off;
0125 
0126 <a name="_sub4" href="#_subfunctions" class="code">function do_unit_test</a>
0127    fmdl= <a href="../../../eidors/meshing/netgen/ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>(1,0,[]);
0128    th = linspace(0,2*pi,50)';
0129    geo.xy=[sin(th),2*cos(th)];
0130    geo.z_mag = 10;
0131    <a href="../../../eidors/graphics_matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(<a href="deform_cylinder.html" class="code" title="function fwd_mdl = deform_cylinder( fwd_mdl, geo);">deform_cylinder</a>(fmdl,geo));
0132    view(2);</pre></div>
<hr><address>Generated on Tue 09-Aug-2011 11:38:31 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>