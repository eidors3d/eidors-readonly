<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of mk_coarse_fine_mapping</title>
  <meta name="keywords" content="mk_coarse_fine_mapping">
  <meta name="description" content="MK_COARSE_FINE_MAPPING: create a mapping matrix from coarse to fine FEM">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html eidors --><!-- ../menu.html algorithms --><!-- menu.html a_adler -->
<h1>mk_coarse_fine_mapping
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>MK_COARSE_FINE_MAPPING: create a mapping matrix from coarse to fine FEM</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function mapping = mk_coarse_fine_mapping( f_mdl, c_mdl ); </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> MK_COARSE_FINE_MAPPING: create a mapping matrix from coarse to fine FEM
 mapping= mk_coarse_fine_mapping( f_mdl, c_mdl );

 Mapping approximates elem_data_fine from elem_data_coase
   elem_data_fine = Mapping*elem_data_coase

 c_mdl is coarse fwd_model
 f_mdl is fine fwd_model

 if the geometry of the fine and coarse models are not
  aligned, then they can be translated and mapped using
    coarse_xyz = M*( fine_xyz - T)
  where
    T= c_mdl.mk_coarse_fine_mapping.f2c_offset (1xN_dims)
    M= c_mdl.mk_coarse_fine_mapping.f2c_project (N_dimsxN_dims)
  by default T= [0,0,0] and M=eye(3)

 if c_mdl is 2D and f_mdl is 3D, then parameter
     c_mdl.mk_coarse_fine_mapping.z_depth
     indicates the +/- z_depth which elements in 2D are
     considered to be extruded in 3D (default inf)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>	INTERP_MESH: calculate interpolation points onto mdl elements</li><li><a href="../../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG: eidors progress and status messages</li><li><a href="../../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>	EIDORS_OBJ: 'constructor' to create a eidors structure</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/algorithms/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>	GET_IMG_DATA: get parameter data from eidors image object</li><li><a href="../../../eidors/examples/object_in_tank_2d.html" class="code" title="">object_in_tank_2d</a>	2D demo example for reconstruction of object floating inside tank with</li><li><a href="../../../eidors/tests/test_c2f_jacobian.html" class="code" title="function test_c2f_jacobian">test_c2f_jacobian</a>	Test calc of jacobian given coarse to fine mapping</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function c_obj = cache_obj(c_mdl, f_mdl)</a></li><li><a href="#_sub2" class="code">function c_elems = all_contained_elems( fm, cm, z_depth)</a></li><li><a href="#_sub3" class="code">function tsn= search_fm_pts_in_cm(cm, fm_pts, z_depth);</a></li><li><a href="#_sub4" class="code">function c_elems = contained_elems_i( fm, cm, idx, z_depth)</a></li><li><a href="#_sub5" class="code">function xyz = interpxyz( xyzmin, xyzmax, n_interp);</a></li><li><a href="#_sub6" class="code">function f_mdl= offset_and_project( f_mdl, c_mdl);</a></li><li><a href="#_sub7" class="code">function c_mdl = assign_defaults( c_mdl, f_mdl );</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function mapping = mk_coarse_fine_mapping( f_mdl, c_mdl );</a>
0002 <span class="comment">% MK_COARSE_FINE_MAPPING: create a mapping matrix from coarse to fine FEM</span>
0003 <span class="comment">% mapping= mk_coarse_fine_mapping( f_mdl, c_mdl );</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% Mapping approximates elem_data_fine from elem_data_coase</span>
0006 <span class="comment">%   elem_data_fine = Mapping*elem_data_coase</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% c_mdl is coarse fwd_model</span>
0009 <span class="comment">% f_mdl is fine fwd_model</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% if the geometry of the fine and coarse models are not</span>
0012 <span class="comment">%  aligned, then they can be translated and mapped using</span>
0013 <span class="comment">%    coarse_xyz = M*( fine_xyz - T)</span>
0014 <span class="comment">%  where</span>
0015 <span class="comment">%    T= c_mdl.mk_coarse_fine_mapping.f2c_offset (1xN_dims)</span>
0016 <span class="comment">%    M= c_mdl.mk_coarse_fine_mapping.f2c_project (N_dimsxN_dims)</span>
0017 <span class="comment">%  by default T= [0,0,0] and M=eye(3)</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% if c_mdl is 2D and f_mdl is 3D, then parameter</span>
0020 <span class="comment">%     c_mdl.mk_coarse_fine_mapping.z_depth</span>
0021 <span class="comment">%     indicates the +/- z_depth which elements in 2D are</span>
0022 <span class="comment">%     considered to be extruded in 3D (default inf)</span>
0023 
0024 <span class="comment">% (C) 2007-2008 Andy Adler. License: GPL version 2 or version 3</span>
0025 <span class="comment">% $Id$</span>
0026 
0027 c_mdl = <a href="#_sub7" class="code" title="subfunction c_mdl = assign_defaults( c_mdl, f_mdl );">assign_defaults</a>( c_mdl, f_mdl );
0028 c_obj = <a href="#_sub1" class="code" title="subfunction c_obj = cache_obj(c_mdl, f_mdl)">cache_obj</a>(c_mdl, f_mdl);
0029 
0030 f_mdl= <a href="#_sub6" class="code" title="subfunction f_mdl= offset_and_project( f_mdl, c_mdl);">offset_and_project</a>( f_mdl, c_mdl);
0031 mapping = <a href="../../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'get-cache'</span>, c_obj, <span class="string">'coarse_fine_mapping'</span>);
0032 <span class="keyword">if</span> ~isempty(mapping)
0033     <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'mk_coarse_fine_mapping: using cached value'</span>, 3);
0034 <span class="keyword">else</span>
0035 
0036     z_depth = c_mdl.mk_coarse_fine_mapping.z_depth;
0037 
0038     f_elems = <a href="#_sub2" class="code" title="subfunction c_elems = all_contained_elems( fm, cm, z_depth)">all_contained_elems</a>( f_mdl, c_mdl, z_depth);
0039     mapping = <a href="#_sub4" class="code" title="subfunction c_elems = contained_elems_i( fm, cm, idx, z_depth)">contained_elems_i</a>( f_mdl, c_mdl, f_elems, z_depth);
0040 
0041     <span class="keyword">if</span> isfield(c_mdl,<span class="string">'coarse2fine'</span>)
0042        mapping = mapping*c_mdl.coarse2fine;
0043     <span class="keyword">end</span>
0044 
0045     <a href="../../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'set-cache'</span>, c_obj, <span class="string">'coarse_fine_mapping'</span>, mapping);
0046     <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'mk_coarse_fine_mapping: setting cached value'</span>, 3);
0047 <span class="keyword">end</span>
0048 
0049 <span class="comment">% Mapping depends only on nodes and elems - remove the other stuff</span>
0050 <a name="_sub1" href="#_subfunctions" class="code">function c_obj = cache_obj(c_mdl, f_mdl)</a>
0051    c_obj = {c_mdl.nodes, c_mdl.elems, c_mdl.mk_coarse_fine_mapping, <span class="keyword">...</span>
0052             f_mdl.nodes, f_mdl.elems};
0053 
0054 <span class="comment">% find all elems of ff_mdl completely contained in cc_mdl</span>
0055 <a name="_sub2" href="#_subfunctions" class="code">function c_elems = all_contained_elems( fm, cm, z_depth)</a>
0056     [nf,ef]= size(fm.elems);
0057     [nc,ec]= size(cm.elems);
0058     fm_pts = zeros(nf*ef,3);
0059     <span class="comment">% shrink pts slightly (s_fac) so they're not on the boundary</span>
0060     <span class="comment">% by shrinking, we avoid cases where an element is</span>
0061     <span class="comment">% only slighly intersecting another. This is beyond the</span>
0062     <span class="comment">% resolution of the next step (interpolation) anyway</span>
0063     s_fac= .9; <span class="comment">% .9999;</span>
0064     <span class="keyword">for</span> dim= 1:ef-1 <span class="comment">% ef-1 is dimensions in fm</span>
0065        <span class="comment">% fm_pts is local_nodes x elems x xyz</span>
0066        fm_pt= reshape(fm.nodes(fm.elems,dim),nf,ef);
0067        fm_ctr= mean(fm_pt,2)*ones(1,ef);
0068        fm_pt = s_fac*(fm_pt-fm_ctr) + fm_ctr;
0069        fm_pts(:,dim) = fm_pt(:);
0070     <span class="keyword">end</span>
0071 
0072     tsn= <a href="#_sub3" class="code" title="subfunction tsn= search_fm_pts_in_cm(cm, fm_pts, z_depth);">search_fm_pts_in_cm</a>(cm, fm_pts, z_depth);
0073     tsn= reshape( tsn, [], ef);
0074     <span class="comment">% if all points are outside (NaN) then c_elems = -1</span>
0075     <span class="comment">% if all points are in one elem   then c_elems = elem #</span>
0076     <span class="comment">% if all points are in diff elems then c_elems = 0</span>
0077     c_elems= all(diff(tsn,1,2)==0,2) .* tsn(:,1);
0078     c_elems(all(tsn==-1,2))= -1; <span class="comment">% all points outside</span>
0079 
0080 
0081 <span class="comment">% tsn = vector of length size(fm_pts,1)</span>
0082 <span class="comment">% tsn(i) = elem in cm which contains point</span>
0083 <span class="comment">% tsn(i) = -1 if point is outside cm (and z_depth, if appropriate)</span>
0084 <a name="_sub3" href="#_subfunctions" class="code">function tsn= search_fm_pts_in_cm(cm, fm_pts, z_depth);</a>
0085     dc= size(cm.elems,2)-1;  <span class="comment">%coarse dim</span>
0086     df= size(fm_pts,2); <span class="comment">%fine dim</span>
0087 
0088     tsn= -ones(size(fm_pts,1),1);
0089     not_oor= (tsn==-1); <span class="comment">% logical 1</span>
0090 
0091     <span class="keyword">if</span> dc==2  <span class="comment">%corse model is 2D</span>
0092 
0093        <span class="keyword">if</span> df==3
0094        <span class="comment">% look for f_mdl z not out of range</span>
0095           not_oor= not_oor &amp;  any( abs(fm_pts(:,3) ) &lt;= z_depth , 2);
0096        <span class="keyword">end</span>
0097        dims=1:2;
0098 
0099     <span class="keyword">elseif</span> dc==3 <span class="comment">%coarse model is 3D</span>
0100 
0101        dims=1:3; 
0102 
0103     <span class="keyword">else</span>
0104        error(<span class="string">'coarse model must be 2 or 3D'</span>);
0105     <span class="keyword">end</span>
0106 
0107     tsn(not_oor)= tsearchn(cm.nodes(:,dims), cm.elems, fm_pts(not_oor,dims));
0108     tsn(isnan(tsn))= -1;
0109 
0110 <span class="comment">% find fraction of elem contained in cm</span>
0111 <span class="comment">% idx is the index into which the elem is contained</span>
0112 <span class="comment">% if idx &gt;= 1, the element is completely with in that coarse elem</span>
0113 <span class="comment">% if idx == 0, the element is crosses several coarse elems</span>
0114 <span class="comment">% if idx ==-1, the element is outside the coarse model</span>
0115 <a name="_sub4" href="#_subfunctions" class="code">function c_elems = contained_elems_i( fm, cm, idx, z_depth)</a>
0116    [nc,dc]= size(cm.elems);
0117    [nf,df]= size(fm.elems);
0118 
0119    fidx= find(idx==0);
0120    l_fidx= length(fidx);
0121 
0122    c_e_i= []; c_e_j=[]; c_e_v=[];
0123 
0124    <span class="comment">% lower density interpolation in higher dimentions, since</span>
0125    <span class="comment">% the added dimensions will give extra interpolation points.</span>
0126    n_interp = 7-df;
0127    interp_mdl.nodes= fm.nodes;
0128    interp_mdl.elems= fm.elems(fidx,:);
0129 
0130    fm_pts = <a href="interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>( interp_mdl, n_interp);
0131    l_interp = size(fm_pts,3);
0132 
0133    fm_pts = permute( fm_pts, [3,1,2]);
0134    fm_pts = reshape(fm_pts, [], df-1);
0135 
0136    tsn= <a href="#_sub3" class="code" title="subfunction tsn= search_fm_pts_in_cm(cm, fm_pts, z_depth);">search_fm_pts_in_cm</a>(cm, fm_pts, z_depth);
0137 
0138    tsn_idx= ones(l_interp,1)*fidx(:)';
0139    tsn_idx= tsn_idx(:);
0140    <span class="comment">% find and isolate outside elements</span>
0141    outside_idx= tsn==-1;
0142    tsn(outside_idx) = [];
0143    tsn_idx(outside_idx) = [];
0144    
0145    in_idx= find(idx&lt;=0);
0146    ridx= 1:nf; ridx(in_idx)=[];
0147    idx(in_idx)=[];
0148 
0149    <span class="comment">% first term is contribution from f_elems in one c_elem</span>
0150    <span class="comment">% next term is contribution from f_elems in many c_elems, weighted</span>
0151    c_elems = sparse(ridx,idx,1,nf,nc) +  <span class="keyword">...</span>
0152              sparse(tsn_idx,tsn,1,nf,nc)/l_interp;
0153       
0154 <span class="comment">% Do 3D interpolation of region xyzmin= [x,y,z] to xyzmax</span>
0155 <span class="comment">%  with n_interp points in the minimum direction</span>
0156 <a name="_sub5" href="#_subfunctions" class="code">function xyz = interpxyz( xyzmin, xyzmax, n_interp);</a>
0157     xyzdelta= xyzmax - xyzmin;
0158     xyz_interp = 1 + floor(n_interp * xyzdelta / max(xyzdelta) );
0159     xspace = linspace(xyzmin(1), xyzmax(1), xyz_interp(1) );
0160     yspace = linspace(xyzmin(2), xyzmax(2), xyz_interp(2) );
0161     zspace = linspace(xyzmin(3), xyzmax(3), xyz_interp(3) );
0162     [xx3,yy3,zz3] = ndgrid( xspace, yspace, zspace );
0163     xyz= [xx3(:), yy3(:), zz3(:)];
0164 
0165 <span class="comment">% Offset and project f_mdl as required</span>
0166 <a name="_sub6" href="#_subfunctions" class="code">function f_mdl= offset_and_project( f_mdl, c_mdl);</a>
0167     [fn,fd]= size(f_mdl.nodes);
0168     T= c_mdl.mk_coarse_fine_mapping.f2c_offset;
0169     M= c_mdl.mk_coarse_fine_mapping.f2c_project;
0170 
0171     f_mdl.nodes= ( f_mdl.nodes - ones(fn,1)*T )*M;
0172 
0173 <a name="_sub7" href="#_subfunctions" class="code">function c_mdl = assign_defaults( c_mdl, f_mdl );</a>
0174     [fn,fd]= size(f_mdl.nodes);
0175     <span class="keyword">try</span>    c_mdl.mk_coarse_fine_mapping.f2c_offset; <span class="comment">% test exist</span>
0176     <span class="keyword">catch</span>  c_mdl.mk_coarse_fine_mapping.f2c_offset= zeros(1,fd);
0177     <span class="keyword">end</span>
0178     <span class="keyword">try</span>    c_mdl.mk_coarse_fine_mapping.f2c_project;
0179     <span class="keyword">catch</span>  c_mdl.mk_coarse_fine_mapping.f2c_project= speye(fd);
0180     <span class="keyword">end</span>
0181     <span class="keyword">try</span>    c_mdl.mk_coarse_fine_mapping.z_depth;
0182     <span class="keyword">catch</span>  c_mdl.mk_coarse_fine_mapping.z_depth= inf;
0183     <span class="keyword">end</span></pre></div>
<hr><address>Generated on Wed 13-Jul-2011 23:23:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>