<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of perturb_jacobian</title>
  <meta name="keywords" content="perturb_jacobian">
  <meta name="description" content="PERTURB_JACOBIAN: J= perturb_jacobian( fwd_model, img)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html?eidors/algorithms/a_adler/perturb_jacobian.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html eidors --><!-- ../menu.html algorithms --><!-- menu.html a_adler -->
<h1>perturb_jacobian
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>PERTURB_JACOBIAN: J= perturb_jacobian( fwd_model, img)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function J= perturb_jacobian( fwd_model, img) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> PERTURB_JACOBIAN: J= perturb_jacobian( fwd_model, img)
 Calculate Jacobian Matrix, based on small perturbations
   in the forward model. This will tend to be slow, but
   should be best used to 'sanity check' other code

 J         = Jacobian matrix
 fwd_model = forward model
 fwd_model.perturb_jacobian.delta   - delta perturbation to use
 img = image background for jacobian calc</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="aa_calc_jacobian.html" class="code" title="function J= aa_calc_jacobian( fwd_model, img)">aa_calc_jacobian</a>	AA_CALC_JACOBIAN: J= aa_calc_jacobian( fwd_model, img)</li><li><a href="aa_calc_system_mat.html" class="code" title="function s_mat= aa_calc_system_mat( fwd_model, img)">aa_calc_system_mat</a>	AA_CALC_SYSTEM_MAT: SS= aa_calc_system_mat( fwd_model, img)</li><li><a href="aa_fwd_solve.html" class="code" title="function data =aa_fwd_solve(fwd_model, img)">aa_fwd_solve</a>	AA_FWD_SOLVE: data= aa_fwd_solve( fwd_model, img)</li><li><a href="perturb_jacobian.html" class="code" title="function J= perturb_jacobian( fwd_model, img)">perturb_jacobian</a>	PERTURB_JACOBIAN: J= perturb_jacobian( fwd_model, img)</li><li><a href="../../../eidors/algorithms/calc_jacobian.html" class="code" title="function J = calc_jacobian( fwd_model, img)">calc_jacobian</a>	CALC_JACOBIAN: calculate jacobian from an inv_model</li><li><a href="../../../eidors/algorithms/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>	CALC_JACOBIAN_BKGND: calculate background image around</li><li><a href="../../../eidors/algorithms/n_polydorides/np_calc_jacobian.html" class="code" title="function J= np_calc_jacobian( fwd_model, img)">np_calc_jacobian</a>	NP_CALC_JACOBIAN: J= np_calc_jacobian( fwd_model, img)</li><li><a href="../../../eidors/algorithms/n_polydorides/np_calc_system_mat.html" class="code" title="function s_mat= np_calc_system_mat( fwd_model, img)">np_calc_system_mat</a>	NP_CALC_SYSTEM_MAT: s_mat= np_calc_system_mat( fwd_model, img)</li><li><a href="../../../eidors/algorithms/n_polydorides/np_fwd_solve.html" class="code" title="function data= np_fwd_solve( fwd_model, img)">np_fwd_solve</a>	NP_FWD_SOLVE: data= np_fwd_solve( fwd_model, img)</li><li><a href="../../../eidors/fwd_solve.html" class="code" title="function data = fwd_solve( fwd_model, img)">fwd_solve</a>	FWD_SOLVE: calculate data from a fwd_model object and an image</li><li><a href="../../../eidors/models/a_adler/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="perturb_jacobian.html" class="code" title="function J= perturb_jacobian( fwd_model, img)">perturb_jacobian</a>	PERTURB_JACOBIAN: J= perturb_jacobian( fwd_model, img)</li><li><a href="../../../eidors/tests/perturb_jacobian_test.html" class="code" title="">perturb_jacobian_test</a>	Perturbation Jacobians</li><li><a href="../../../eidors/tests/test_2d_resistor.html" class="code" title="">test_2d_resistor</a>	Create 2D model of a cylindrical resistor</li><li><a href="../../../eidors/tests/test_3d_resistor.html" class="code" title="">test_3d_resistor</a>	Create 3D model of a Rectangular resistor</li><li><a href="../../../eidors/tests/test_c2f_jacobian.html" class="code" title="function test_c2f_jacobian">test_c2f_jacobian</a>	Test calc of jacobian given coarse to fine mapping</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function Jcol= perturb( img, i, delta, d0)</a></li><li><a href="#_sub2" class="code">function Jcol= perturb_c2f( img, i, delta, d0)</a></li><li><a href="#_sub3" class="code">function do_unit_test</a></li><li><a href="#_sub4" class="code">function display_jacobian_deltas</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function J= perturb_jacobian( fwd_model, img)</a>
0002 <span class="comment">% PERTURB_JACOBIAN: J= perturb_jacobian( fwd_model, img)</span>
0003 <span class="comment">% Calculate Jacobian Matrix, based on small perturbations</span>
0004 <span class="comment">%   in the forward model. This will tend to be slow, but</span>
0005 <span class="comment">%   should be best used to 'sanity check' other code</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% J         = Jacobian matrix</span>
0008 <span class="comment">% fwd_model = forward model</span>
0009 <span class="comment">% fwd_model.perturb_jacobian.delta   - delta perturbation to use</span>
0010 <span class="comment">% img = image background for jacobian calc</span>
0011 
0012 <span class="comment">% (C) 2006 Andy Adler. License: GPL version 2 or version 3</span>
0013 <span class="comment">% $Id$</span>
0014 
0015 <span class="keyword">if</span> isstr(fwd_model) &amp;&amp; strcmp(fwd_model,<span class="string">'UNIT_TEST'</span>); <a href="#_sub3" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>;<span class="keyword">end</span>
0016 
0017 <span class="keyword">if</span> isfield(fwd_model,<span class="string">'perturb_jacobian'</span>)
0018    delta = fwd_model.perturb_jacobian.delta;
0019 <span class="keyword">else</span>
0020    delta= 1e-6; <span class="comment">% tests indicate this is a good value</span>
0021 <span class="keyword">end</span>
0022 
0023 n_elem = size(fwd_model.elems,1);
0024 <span class="comment">% force image to use provided fwd_model</span>
0025 img.fwd_model= fwd_model;
0026 
0027 <span class="comment">% solve one time to get the size</span>
0028 d0= <a href="../../../eidors/fwd_solve.html" class="code" title="function data = fwd_solve( fwd_model, img)">fwd_solve</a>( img );
0029 
0030 <span class="keyword">if</span> isfield(img.fwd_model,<span class="string">'coarse2fine'</span>);
0031    Jcol= <a href="#_sub2" class="code" title="subfunction Jcol= perturb_c2f( img, i, delta, d0)">perturb_c2f</a>(img, 1, delta, d0);
0032    Jrows= size(img.fwd_model.coarse2fine,2);
0033    J= zeros(length(Jcol), Jrows );
0034    J(:,1)= Jcol;
0035    <span class="keyword">for</span> i=2:size(img.fwd_model.coarse2fine,2);
0036      J(:,i)= <a href="#_sub2" class="code" title="subfunction Jcol= perturb_c2f( img, i, delta, d0)">perturb_c2f</a>(img, i, delta, d0);
0037      <span class="keyword">if</span> rem(i,50)==0; fprintf(<span class="string">'+'</span>); <span class="keyword">end</span>
0038    <span class="keyword">end</span>
0039 <span class="keyword">else</span>
0040    Jcol= <a href="#_sub1" class="code" title="subfunction Jcol= perturb( img, i, delta, d0)">perturb</a>(img, 1, delta, d0);
0041 
0042    J= zeros(length(Jcol), n_elem);
0043    J(:,1)= Jcol;
0044 
0045    <span class="keyword">for</span> i=2:n_elem
0046      J(:,i)= <a href="#_sub1" class="code" title="subfunction Jcol= perturb( img, i, delta, d0)">perturb</a>(img, i, delta, d0);
0047    <span class="keyword">end</span>
0048 <span class="keyword">end</span>
0049 
0050 
0051 <a name="_sub1" href="#_subfunctions" class="code">function Jcol= perturb( img, i, delta, d0)</a>
0052    img.elem_data(i)= img.elem_data(i) + delta;
0053    di= <a href="../../../eidors/fwd_solve.html" class="code" title="function data = fwd_solve( fwd_model, img)">fwd_solve</a>( img );
0054    Jcol = (1/delta) * (di.meas - d0.meas);
0055 
0056 <a name="_sub2" href="#_subfunctions" class="code">function Jcol= perturb_c2f( img, i, delta, d0)</a>
0057    img.elem_data= img.elem_data + delta*img.fwd_model.coarse2fine(:,i);
0058    di= <a href="../../../eidors/fwd_solve.html" class="code" title="function data = fwd_solve( fwd_model, img)">fwd_solve</a>( img );
0059    Jcol = (1/delta) * (di.meas - d0.meas);
0060 
0061 
0062 <a name="_sub3" href="#_subfunctions" class="code">function do_unit_test</a>
0063 <span class="comment">% Perturbation Jacobians</span>
0064 <span class="comment">% $Id$</span>
0065 
0066 <span class="comment">% imdl= mk_common_model('c2c2',16);</span>
0067   imdl= <a href="../../../eidors/models/a_adler/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a3cr'</span>,16);
0068 <span class="comment">% imdl= mk_common_model('n3r2',16);</span>
0069   imdl.fwd_model.nodes = imdl.fwd_model.nodes*.25;
0070   img= <a href="../../../eidors/algorithms/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(imdl);
0071 
0072   img.fwd_model.normalize_measurements= 0;
0073 
0074   img.fwd_model.jacobian=   @<a href="aa_calc_jacobian.html" class="code" title="function J= aa_calc_jacobian( fwd_model, img)">aa_calc_jacobian</a>;
0075   img.fwd_model.system_mat= @<a href="aa_calc_system_mat.html" class="code" title="function s_mat= aa_calc_system_mat( fwd_model, img)">aa_calc_system_mat</a>;
0076   img.fwd_model.solve=      @<a href="aa_fwd_solve.html" class="code" title="function data =aa_fwd_solve(fwd_model, img)">aa_fwd_solve</a>;
0077   J_aa= <a href="../../../eidors/algorithms/calc_jacobian.html" class="code" title="function J = calc_jacobian( fwd_model, img)">calc_jacobian</a>( img ); <span class="comment">% 2 for bug in my code</span>
0078 
0079   img.fwd_model.jacobian=   @<a href="perturb_jacobian.html" class="code" title="function J= perturb_jacobian( fwd_model, img)">perturb_jacobian</a>;
0080   img.fwd_model.system_mat= @<a href="aa_calc_system_mat.html" class="code" title="function s_mat= aa_calc_system_mat( fwd_model, img)">aa_calc_system_mat</a>;
0081   img.fwd_model.solve=      @<a href="aa_fwd_solve.html" class="code" title="function data =aa_fwd_solve(fwd_model, img)">aa_fwd_solve</a>;
0082   J_aa_p= <a href="../../../eidors/algorithms/calc_jacobian.html" class="code" title="function J = calc_jacobian( fwd_model, img)">calc_jacobian</a>( img ); <span class="comment">% 2 for bug in my code</span>
0083 
0084   img.fwd_model.jacobian=   @<a href="../../../eidors/algorithms/n_polydorides/np_calc_jacobian.html" class="code" title="function J= np_calc_jacobian( fwd_model, img)">np_calc_jacobian</a>;
0085   img.fwd_model.system_mat= @<a href="../../../eidors/algorithms/n_polydorides/np_calc_system_mat.html" class="code" title="function s_mat= np_calc_system_mat( fwd_model, img)">np_calc_system_mat</a>;
0086   img.fwd_model.solve=      @<a href="../../../eidors/algorithms/n_polydorides/np_fwd_solve.html" class="code" title="function data= np_fwd_solve( fwd_model, img)">np_fwd_solve</a>;
0087   J_np= <a href="../../../eidors/algorithms/calc_jacobian.html" class="code" title="function J = calc_jacobian( fwd_model, img)">calc_jacobian</a>( img );
0088 
0089   img.fwd_model.jacobian=   @<a href="perturb_jacobian.html" class="code" title="function J= perturb_jacobian( fwd_model, img)">perturb_jacobian</a>;
0090   img.fwd_model.system_mat= @<a href="../../../eidors/algorithms/n_polydorides/np_calc_system_mat.html" class="code" title="function s_mat= np_calc_system_mat( fwd_model, img)">np_calc_system_mat</a>;
0091   img.fwd_model.solve=      @<a href="../../../eidors/algorithms/n_polydorides/np_fwd_solve.html" class="code" title="function data= np_fwd_solve( fwd_model, img)">np_fwd_solve</a>;
0092   J_np_p= <a href="../../../eidors/algorithms/calc_jacobian.html" class="code" title="function J = calc_jacobian( fwd_model, img)">calc_jacobian</a>( img );
0093 
0094   tol = 4e-4;
0095   <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'J_aa - J_aa_p'</span>, norm(J_aa - J_aa_p,<span class="string">'fro'</span>)/norm(J_aa,<span class="string">'fro'</span>), 0, tol);
0096   <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'J_np - J_np_p'</span>, norm(J_np - J_np_p,<span class="string">'fro'</span>)/norm(J_np,<span class="string">'fro'</span>), 0, tol);
0097   <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'J_np - J_aa_p'</span>, norm(J_np - J_aa_p,<span class="string">'fro'</span>)/norm(J_np,<span class="string">'fro'</span>), 0, tol);
0098   <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'J_np - J_aa  '</span>, norm(J_np - J_aa  ,<span class="string">'fro'</span>)/norm(J_np,<span class="string">'fro'</span>), 0, tol);
0099 
0100 <span class="comment">% Demo model with EIDORS3D</span>
0101   imdl= <a href="../../../eidors/models/a_adler/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>,16);
0102   img= <a href="../../../eidors/algorithms/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(imdl);
0103   <span class="keyword">for</span> i=1:16; imdl.fwd_model.electrode(i).z_contact= .01;<span class="keyword">end</span>
0104 
0105 <span class="comment">% Calculate the normal Jacobian</span>
0106   img.fwd_model.jacobian=   @<a href="../../../eidors/algorithms/n_polydorides/np_calc_jacobian.html" class="code" title="function J= np_calc_jacobian( fwd_model, img)">np_calc_jacobian</a>;
0107   img.fwd_model.system_mat= @<a href="../../../eidors/algorithms/n_polydorides/np_calc_system_mat.html" class="code" title="function s_mat= np_calc_system_mat( fwd_model, img)">np_calc_system_mat</a>;
0108   img.fwd_model.solve=      @<a href="../../../eidors/algorithms/n_polydorides/np_fwd_solve.html" class="code" title="function data= np_fwd_solve( fwd_model, img)">np_fwd_solve</a>;
0109   J_np= <a href="../../../eidors/algorithms/calc_jacobian.html" class="code" title="function J = calc_jacobian( fwd_model, img)">calc_jacobian</a>( img );
0110 
0111 <a name="_sub4" href="#_subfunctions" class="code">function display_jacobian_deltas</a>
0112 <span class="comment">% Calculate the perturbation Jacobian</span>
0113   vh= <a href="../../../eidors/fwd_solve.html" class="code" title="function data = fwd_solve( fwd_model, img)">fwd_solve</a>(img);
0114 
0115   <span class="keyword">for</span> el= 1:50:size(img.fwd_model.elems,1);
0116      fprintf(<span class="string">'\nelem#%03d: '</span>,el);
0117      <span class="keyword">for</span> delta= [1e-4,1e-6,1e-8] <span class="comment">% delta is perturb</span>
0118         img_i = img;
0119         img_i.elem_data(el)= img_i.elem_data(el) + delta;
0120         vi= <a href="../../../eidors/fwd_solve.html" class="code" title="function data = fwd_solve( fwd_model, img)">fwd_solve</a>(img_i);
0121         J_p = (vi.meas - vh.meas)/delta; <span class="comment">% perturb Jacobian</span>
0122         fprintf(<span class="string">' %8.6f'</span>, norm(J_p - J_np(:,el))/norm(J_np(:,el)));
0123      <span class="keyword">end</span>
0124   <span class="keyword">end</span>
0125</pre></div>
<hr><address>Generated on Tue 09-Aug-2011 11:38:31 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>