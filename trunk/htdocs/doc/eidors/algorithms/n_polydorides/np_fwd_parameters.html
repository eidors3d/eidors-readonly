<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of np_fwd_parameters</title>
  <meta name="keywords" content="np_fwd_parameters">
  <meta name="description" content="NP_FWD_PARAMETERS: data= np_fwd_solve( fwd_model )">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html eidors --><!-- ../menu.html algorithms --><!-- menu.html n_polydorides -->
<h1>np_fwd_parameters
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>NP_FWD_PARAMETERS: data= np_fwd_solve( fwd_model )</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function param = np_fwd_parameters( fwd_model ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> NP_FWD_PARAMETERS: data= np_fwd_solve( fwd_model )
 Extract parameters from a 'fwd_model' struct which are 
 appropriate for Nick Polydorides EIDORS3D code
   param.n_elem   =&gt; number of elements
   param.n_elec   =&gt; number of electrodes
   param.n_node   =&gt; number of nodes (vertices)
   param.n_stim   =&gt; number of current stimulation patterns
   param.n_meas   =&gt; number of measurements (total)
   param.vtx      =&gt; vertex matrix
   param.simp     =&gt; connection matrix
   param.srf      =&gt; boundary triangles
   param.df       =&gt; vector of measurements for each current pattern
   param.elec     =&gt; nodes attached to each electrode
   param.zc       =&gt; vector of contact impedances
   param.indH     =&gt; electrodes used for each measurement
   param.I        =&gt; RHS (current term) for FEM solution
   param.Ib       =&gt; Current for electrodes
   param.perm_sym =&gt; 'sym' parameter
   param.gnd_ind  =&gt; node attached to ground
   param.normalize  =&gt; difference measurements normalized?</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="find_boundary.html" class="code" title="function [srf, idx] = find_boundary(simp);">find_boundary</a>	[srf, idx] = find_boundary(simp);</li><li><a href="../../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG: eidors progress and status messages</li><li><a href="../../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>	EIDORS_OBJ: 'constructor' to create a eidors structure</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/algorithms/d_stephenson/inv_solve_dual_mesh.html" class="code" title="function img= inv_solve_dual_mesh( inv_model, voltage)">inv_solve_dual_mesh</a>	INV_SOLVE_DUAL_MESH using a coarse and fine mesh</li><li><a href="np_calc_3d_fields.html" class="code" title="function v_f= np_calc_3d_fields( fwd_model, img)">np_calc_3d_fields</a>	NP_CALC_3D_FIELDS: J= np_calc_3d_fields( fwd_model, img)</li><li><a href="np_calc_jacobian.html" class="code" title="function J= np_calc_jacobian( fwd_model, img)">np_calc_jacobian</a>	NP_CALC_JACOBIAN: J= np_calc_jacobian( fwd_model, img)</li><li><a href="np_calc_system_mat.html" class="code" title="function s_mat= np_calc_system_mat( fwd_model, img)">np_calc_system_mat</a>	NP_CALC_SYSTEM_MAT: s_mat= np_calc_system_mat( fwd_model, img)</li><li><a href="np_fwd_solve.html" class="code" title="function data= np_fwd_solve( fwd_model, img)">np_fwd_solve</a>	NP_FWD_SOLVE: data= np_fwd_solve( fwd_model, img)</li><li><a href="../../../eidors/graphics_matlab/display_meas.html" class="code" title="function display_meas(fwd_model,disp_meas,offset,elec_pp);">display_meas</a>	DISPLAY_MEAS: display measurements on mesh</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function param= calc_param( fwd_model );</a></li><li><a href="#_sub2" class="code">function e_bdy  = bdy_with_nodes(bdy,  elec_nodes );</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function param = np_fwd_parameters( fwd_model )</a>
0002 <span class="comment">% NP_FWD_PARAMETERS: data= np_fwd_solve( fwd_model )</span>
0003 <span class="comment">% Extract parameters from a 'fwd_model' struct which are</span>
0004 <span class="comment">% appropriate for Nick Polydorides EIDORS3D code</span>
0005 <span class="comment">%   param.n_elem   =&gt; number of elements</span>
0006 <span class="comment">%   param.n_elec   =&gt; number of electrodes</span>
0007 <span class="comment">%   param.n_node   =&gt; number of nodes (vertices)</span>
0008 <span class="comment">%   param.n_stim   =&gt; number of current stimulation patterns</span>
0009 <span class="comment">%   param.n_meas   =&gt; number of measurements (total)</span>
0010 <span class="comment">%   param.vtx      =&gt; vertex matrix</span>
0011 <span class="comment">%   param.simp     =&gt; connection matrix</span>
0012 <span class="comment">%   param.srf      =&gt; boundary triangles</span>
0013 <span class="comment">%   param.df       =&gt; vector of measurements for each current pattern</span>
0014 <span class="comment">%   param.elec     =&gt; nodes attached to each electrode</span>
0015 <span class="comment">%   param.zc       =&gt; vector of contact impedances</span>
0016 <span class="comment">%   param.indH     =&gt; electrodes used for each measurement</span>
0017 <span class="comment">%   param.I        =&gt; RHS (current term) for FEM solution</span>
0018 <span class="comment">%   param.Ib       =&gt; Current for electrodes</span>
0019 <span class="comment">%   param.perm_sym =&gt; 'sym' parameter</span>
0020 <span class="comment">%   param.gnd_ind  =&gt; node attached to ground</span>
0021 <span class="comment">%   param.normalize  =&gt; difference measurements normalized?</span>
0022 
0023 
0024 <span class="comment">% (C) 2005 Andy Adler. License: GPL version 2 or version 3</span>
0025 <span class="comment">% $Id$</span>
0026 
0027 param = <a href="../../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'get-cache'</span>, fwd_model, <span class="string">'np_fwd_parameters'</span>);
0028 
0029 <span class="keyword">if</span> ~isempty(param)
0030    <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'np_fwd_parameters: using cached value'</span>, 3);
0031    <span class="keyword">return</span>
0032 <span class="keyword">end</span>
0033 
0034 param = <a href="#_sub1" class="code" title="subfunction param= calc_param( fwd_model );">calc_param</a>( fwd_model );
0035 
0036 <a href="../../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'set-cache'</span>, fwd_model, <span class="string">'np_fwd_parameters'</span>, param);
0037 <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'np_fwd_parameters: setting cached value'</span>, 3);
0038 
0039 <span class="comment">% perform actual parameter calculation</span>
0040 <a name="_sub1" href="#_subfunctions" class="code">function param= calc_param( fwd_model );</a>
0041 
0042 vtx= fwd_model.nodes;
0043 simp= fwd_model.elems;
0044 <span class="comment">% calc num electrodes, nodes, stim_patterns</span>
0045 n_elem= size(simp,1);
0046 n_elec=  length(fwd_model.electrode );
0047 n_node = size(fwd_model.nodes,1);
0048 n_stim = length(fwd_model.stimulation );
0049 n_meas = 0;
0050 
0051 <span class="comment">% Recreate 'df' from fwd_model.stimulation</span>
0052 df= zeros(n_stim,1);
0053 <span class="keyword">for</span> i=1:n_stim;
0054     df(i) = size(fwd_model.stimulation(i).meas_pattern ,1);
0055     n_meas = n_meas + df(i);
0056 <span class="keyword">end</span>
0057 
0058 elec= [];
0059 zc  = zeros(n_elec, 1);
0060 
0061 <span class="keyword">if</span> isfield(fwd_model,<span class="string">'boundary'</span>)
0062     srf = fwd_model.boundary;
0063 <span class="keyword">else</span>
0064     srf= <a href="find_boundary.html" class="code" title="function [srf, idx] = find_boundary(simp);">find_boundary</a>(simp);
0065 <span class="keyword">end</span>
0066 
0067 max_elec_nodes=0;
0068 <span class="comment">% get electrode parameters</span>
0069 <span class="keyword">for</span> i=1:n_elec
0070     elec_nodes= fwd_model.electrode(i).nodes;
0071     <span class="keyword">if</span> length(elec_nodes)&gt;1
0072        e_bdy  = <a href="#_sub2" class="code" title="subfunction e_bdy  = bdy_with_nodes(bdy,  elec_nodes );">bdy_with_nodes</a>(srf,  elec_nodes );
0073        n_bdy  = srf(e_bdy,:)';
0074     <span class="keyword">else</span>
0075        n_bdy= elec_nodes;
0076     <span class="keyword">end</span>
0077 <span class="comment">% elec is a series of nodes matching bdy faces</span>
0078     en_list{i}= n_bdy(:)';
0079     <span class="keyword">if</span> length(n_bdy) &gt; max_elec_nodes
0080         max_elec_nodes = length(n_bdy);
0081     <span class="keyword">end</span>
0082 
0083 <span class="comment">% contact impedance</span>
0084     zc(i)    = fwd_model.electrode(i).z_contact;
0085 <span class="keyword">end</span>
0086 
0087 elec= zeros(n_elec, max_elec_nodes);
0088 <span class="keyword">for</span> i=1:n_elec
0089     en= en_list{i};
0090     elec(i,1:length(en)) = en;
0091 <span class="keyword">end</span>
0092 
0093 <span class="comment">% Recreate 'indH' from fwd_model.stimulation</span>
0094 indH= zeros(n_stim, 2);
0095 idx=0;
0096 <span class="keyword">for</span> i=1:n_stim
0097    meas_pat= fwd_model.stimulation(i).meas_pattern';
0098 
0099    sourcepos= find(meas_pat(:)== 1);
0100    sourcepos= rem( sourcepos-1 , n_elec) + 1;
0101 
0102    sinkpos  = find(meas_pat(:)==-1);
0103    sinkpos  = rem( sinkpos  -1 , n_elec) + 1;
0104 
0105    indH( idx+(1:df(i)) , : ) = [sourcepos, sinkpos];
0106    idx= idx+ df(i);
0107 <span class="keyword">end</span>
0108 
0109 <span class="comment">% calculate FEM RHS matrix, i.e., the current patterns padded with zeroes</span>
0110 I = zeros( n_elec + n_node, n_stim );
0111 idx=0;
0112 <span class="keyword">for</span> i=1:n_stim
0113    I( n_node + (1:n_elec), i ) = <span class="keyword">...</span>
0114          fwd_model.stimulation(i).stim_pattern;
0115 <span class="keyword">end</span>
0116 I(fwd_model.gnd_node,:) = 0;
0117 Ib= I( n_node + (1:n_elec), : );
0118 
0119 <span class="comment">% pack into a parameter return list</span>
0120 param.n_elem   = n_elem;
0121 param.n_elec   = n_elec;
0122 param.n_node   = n_node;
0123 param.n_stim   = n_stim;
0124 param.n_meas   = n_meas;
0125 param.vtx      = vtx;
0126 param.simp     = simp;
0127 param.srf      = srf;
0128 param.df       = df;
0129 param.elec     = elec;
0130 param.zc       = zc;
0131 param.indH     = indH;
0132 param.I        = I;
0133 param.Ib       = Ib;
0134 <span class="keyword">try</span>
0135    param.perm_sym = fwd_model.np_fwd_solve.perm_sym;
0136 <span class="keyword">catch</span>
0137    param.perm_sym = <span class="string">'{n}'</span>;
0138 <span class="keyword">end</span>
0139 param.gnd_ind  = fwd_model.gnd_node;
0140 
0141 <span class="keyword">if</span> isfield(fwd_model,<span class="string">'normalize_measurements'</span>)
0142    param.normalize = fwd_model.normalize_measurements;
0143 <span class="keyword">else</span>
0144    param.normalize = 0;
0145 <span class="keyword">end</span>
0146 
0147 
0148 
0149 <span class="comment">% get boundary faces which match nodes</span>
0150 <a name="_sub2" href="#_subfunctions" class="code">function e_bdy  = bdy_with_nodes(bdy,  elec_nodes );</a>
0151    mbdy= zeros(size(bdy));
0152    <span class="keyword">for</span> n= elec_nodes(:)'
0153       mbdy= mbdy + (bdy == n); 
0154    <span class="keyword">end</span> 
0155    e_bdy = find( all(mbdy') );
0156 
0157 <span class="comment">% get boundary faces which match any node</span>
0158 <span class="comment">% Use this for point electrodes where there are no bdy faces</span>
0159 <span class="comment">% This is sort of an abuse of the model, but at least it can</span>
0160 <span class="comment">% produce a reasonable result for pt electrode mdls.</span>
0161 
0162    <span class="keyword">if</span> isempty(e_bdy)
0163       e_bdy = find( sum(mbdy')&gt;=2 );
0164    <span class="keyword">end</span>
0165    <span class="keyword">if</span> isempty(e_bdy)
0166       e_bdy = find( any(mbdy') );
0167    <span class="keyword">end</span></pre></div>
<hr><address>Generated on Wed 13-Jul-2011 23:23:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>