<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of inv_solve_dual_mesh</title>
  <meta name="keywords" content="inv_solve_dual_mesh">
  <meta name="description" content="INV_SOLVE_DUAL_MESH using a coarse and fine mesh">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html?eidors/algorithms/d_stephenson/inv_solve_dual_mesh.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html eidors --><!-- ../menu.html algorithms --><!-- menu.html d_stephenson -->
<h1>inv_solve_dual_mesh
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>INV_SOLVE_DUAL_MESH using a coarse and fine mesh</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function img= inv_solve_dual_mesh( inv_model, voltage) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> INV_SOLVE_DUAL_MESH using a coarse and fine mesh
 img= inv_solve_dual_mesh( inv_model, data1)
 img        =&gt; output image (or vector of images)
 inv_model  =&gt; inverse model struct
 data1      =&gt; EIT data object</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/algorithms/calc_RtR_prior.html" class="code" title="function RtR_prior = calc_RtR_prior( inv_model )">calc_RtR_prior</a>	RtR = calc_RtR_prior( inv_model )</li><li><a href="../../../eidors/algorithms/calc_hyperparameter.html" class="code" title="function hyperparameter = calc_hyperparameter( inv_model )">calc_hyperparameter</a>	CALC_HYPERPARAMETER: calculate hyperparameter value</li><li><a href="edge_refined_elem_mapper.html" class="code" title="function [index_simp]=edge_refined_elem_mapper( mdl_coarse, mdl_dense)">edge_refined_elem_mapper</a>	EDGE_REFINED_ELEM_MAPPER: map elements from coarse to dense model</li><li><a href="edge_refined_node_mapper.html" class="code" title="function [index_vtx] = edge_refined_node_mapper(mdl_coarse, mdl_dense);">edge_refined_node_mapper</a>	EDGE_REFINED_NODE_MAPPER:</li><li><a href="jacobian_3d_with_fields.html" class="code" title="function [J] = jacobian_3d_with_fields(V,Ela,D,I,elec,vtx,simp,gnd_ind,mat_ref,zc,v_f,df,tol,sym);">jacobian_3d_with_fields</a>	JACOBIAN_3D_WITH_FIELDS: calculate jacobian_3d, but accept V fields as</li><li><a href="../../../eidors/algorithms/n_polydorides/fem_master_full.html" class="code" title="function [E,D,Ela,pp] = fem_master_full(vtx,simp,mat,gnd_ind,elec,zc,perm_sym);">fem_master_full</a>	function [E,D,Ela,pp] = fem_master_full(vtx,simp,mat,gnd_ind,elec,zc,perm_sym);</li><li><a href="../../../eidors/algorithms/n_polydorides/forward_solver.html" class="code" title="function [V] = forward_solver(E,I,tol,pp,V, compat_param);">forward_solver</a>	[V] = forward_solver(E,I,tol,pp,V);</li><li><a href="../../../eidors/algorithms/n_polydorides/get_3d_meas.html" class="code" title="function [voltageH,voltageV,indH,indV,df] = get_3d_meas(elec,vtx,V,Ib,no_pl);">get_3d_meas</a>	GET_3D_MEAS: extracts multiplane voltage measurements from a calculated</li><li><a href="../../../eidors/algorithms/n_polydorides/m_3d_fields.html" class="code" title="function [v_f] = m_3d_fields(vtx,el_no,m_ind,E,tol,gnd_ind,v_f);">m_3d_fields</a>	function [v_f] = m_3d_fields(vtx,el_no,m_ind,E,tol,gnd_ind,v_f);</li><li><a href="../../../eidors/algorithms/n_polydorides/np_fwd_parameters.html" class="code" title="function param = np_fwd_parameters( fwd_model )">np_fwd_parameters</a>	NP_FWD_PARAMETERS: data= np_fwd_solve( fwd_model )</li><li><a href="../../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>	EIDORS_OBJ: 'constructor' to create a eidors structure</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function voltH = elec_volts( Vfwd, fwd_model)</a></li><li><a href="#_sub2" class="code">function [V_coarse] = mapvd(V_dense,index_vtx,elec,vtx_coarse,vtx_dense);</a></li><li><a href="#_sub3" class="code">function [v_f_coarse] = mapvm(v_f_dense,index_vtx,indH_dense,vtx_coarse,vtx_dense);</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function img= inv_solve_dual_mesh( inv_model, voltage)</a>
0002 <span class="comment">% INV_SOLVE_DUAL_MESH using a coarse and fine mesh</span>
0003 <span class="comment">% img= inv_solve_dual_mesh( inv_model, data1)</span>
0004 <span class="comment">% img        =&gt; output image (or vector of images)</span>
0005 <span class="comment">% inv_model  =&gt; inverse model struct</span>
0006 <span class="comment">% data1      =&gt; EIT data object</span>
0007 <span class="comment">%</span>
0008 
0009 <span class="comment">% (C) 2005 David Stephenson. License: GPL version 2 or version 3</span>
0010 <span class="comment">% $Id$</span>
0011 
0012 M_dense= inv_model.fwd_model;
0013 <span class="comment">% Load parameters</span>
0014 M_coarse= inv_model.inv_solve_dual_mesh.coarse_mdl;
0015 <span class="comment">%mapper_func= inv_model.inv_solve_dual_mesh.mapper_func;</span>
0016 
0017 [index_simp]=<a href="edge_refined_elem_mapper.html" class="code" title="function [index_simp]=edge_refined_elem_mapper( mdl_coarse, mdl_dense)">edge_refined_elem_mapper</a>( M_coarse, M_dense);
0018 c2d_elem= index_simp(:,1);
0019 [index_vtx]=<a href="edge_refined_node_mapper.html" class="code" title="function [index_vtx] = edge_refined_node_mapper(mdl_coarse, mdl_dense);">edge_refined_node_mapper</a>( M_coarse, M_dense);
0020 d2c_node= index_vtx(:,1);
0021 
0022 <span class="comment">%FIXME: create parameters</span>
0023 tol_for= 1e-5;
0024 tol_inv= 1e-5;
0025 
0026 tfac= <a href="../../../eidors/algorithms/calc_hyperparameter.html" class="code" title="function hyperparameter = calc_hyperparameter( inv_model )">calc_hyperparameter</a>(inv_model);
0027 IM_coarse= inv_model; IM_coarse.fwd_model= M_coarse;
0028 RtR= <a href="../../../eidors/algorithms/calc_RtR_prior.html" class="code" title="function RtR_prior = calc_RtR_prior( inv_model )">calc_RtR_prior</a>( IM_coarse );
0029 
0030 <span class="comment">% Initial conductivity estimate</span>
0031 mat_ref_coarse = ones(size(M_coarse.elems,1),1);
0032 mat_ref_coarse(:)= inv_model.jacobian_bkgnd.value;
0033 mat_ref_dense= mat_ref_coarse( c2d_elem );
0034 <span class="comment">% Initial estimate - homogeneous background coarse mesh</span>
0035 sol_upd_dense= mat_ref_dense;
0036 sol_upd_coarse = mat_ref_coarse;
0037 
0038 index_simp=<a href="edge_refined_elem_mapper.html" class="code" title="function [index_simp]=edge_refined_elem_mapper( mdl_coarse, mdl_dense)">edge_refined_elem_mapper</a>(M_coarse,M_dense);
0039 
0040 <span class="comment">% create dense model</span>
0041 img_dense= <a href="../../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'image'</span>, <span class="string">'dense image'</span>);
0042 img_dense.elem_data= mat_ref_dense;
0043 img_dense.fwd_model= M_dense;
0044 pdense= <a href="../../../eidors/algorithms/n_polydorides/np_fwd_parameters.html" class="code" title="function param = np_fwd_parameters( fwd_model )">np_fwd_parameters</a>( M_dense );
0045 vtx_dense      = pdense.vtx;
0046 simp_dense     = pdense.simp;
0047 gnd_ind_dense  = pdense.gnd_ind;
0048 elec_dense     = pdense.elec;
0049 I_dense        = pdense.I;
0050 Ib_dense       = pdense.Ib;
0051 df_dense       = pdense.df;
0052 elec_dense     = pdense.elec;
0053 zc             = pdense.zc;
0054 perm_sym       = pdense.perm_sym;
0055 no_pl          = 1; <span class="comment">% FIXME</span>
0056 el_no          = pdense.n_elec;
0057 
0058 <span class="comment">% create coarse model</span>
0059 img_coarse= <a href="../../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'image'</span>, <span class="string">'coarse image'</span>);
0060 img_coarse.elem_data= mat_ref_coarse;
0061 img_coarse.fwd_model= M_coarse;
0062 pcoarse= <a href="../../../eidors/algorithms/n_polydorides/np_fwd_parameters.html" class="code" title="function param = np_fwd_parameters( fwd_model )">np_fwd_parameters</a>( M_coarse );
0063 vtx_coarse      = pcoarse.vtx;
0064 simp_coarse     = pcoarse.simp;
0065 gnd_ind_coarse  = pcoarse.gnd_ind;
0066 elec_coarse     = pcoarse.elec;
0067 I_coarse        = pcoarse.I;
0068 Ib_coarse       = pcoarse.Ib;
0069 df_coarse       = pcoarse.df;
0070 elec_coarse     = pcoarse.elec;
0071 
0072 <span class="comment">%Set the tolerance for the forward solver</span>
0073 <span class="keyword">for</span> iter= 1:inv_model.parameters.max_iterations;                     
0074     [E_dense,D_dense,Ela_dense,pp_dense] = <span class="keyword">...</span>
0075         <a href="../../../eidors/algorithms/n_polydorides/fem_master_full.html" class="code" title="function [E,D,Ela,pp] = fem_master_full(vtx,simp,mat,gnd_ind,elec,zc,perm_sym);">fem_master_full</a>(vtx_dense,simp_dense,sol_upd_dense,gnd_ind_dense,elec_dense,zc,perm_sym);
0076  
0077  <span class="keyword">if</span> iter==1
0078    <span class="comment">%sprintf('Current fields for iteration %d',i)</span>
0079    [V_dense] = <a href="../../../eidors/algorithms/n_polydorides/forward_solver.html" class="code" title="function [V] = forward_solver(E,I,tol,pp,V, compat_param);">forward_solver</a>(E_dense,I_dense,tol_for,pp_dense);
0080    [viH,viV,indH_dense,indV,df] = <a href="../../../eidors/algorithms/n_polydorides/get_3d_meas.html" class="code" title="function [voltageH,voltageV,indH,indV,df] = get_3d_meas(elec,vtx,V,Ib,no_pl);">get_3d_meas</a>(elec_dense,vtx_dense,V_dense,Ib_dense,no_pl);
0081    dfv = df(1:2:end);
0082    vi = (viH); 
0083    <span class="comment">%sprintf('Measurement fields for iteration %d',i)</span>
0084    [v_f_dense] = <a href="../../../eidors/algorithms/n_polydorides/m_3d_fields.html" class="code" title="function [v_f] = m_3d_fields(vtx,el_no,m_ind,E,tol,gnd_ind,v_f);">m_3d_fields</a>(vtx_dense,el_no,indH_dense,E_dense,tol_for,gnd_ind_dense);
0085 <span class="keyword">else</span>
0086    <span class="comment">%sprintf('Current fields for iteration %d',i)</span>
0087    [V_dense] = <a href="../../../eidors/algorithms/n_polydorides/forward_solver.html" class="code" title="function [V] = forward_solver(E,I,tol,pp,V, compat_param);">forward_solver</a>(E_dense,I_dense,tol_for,pp_dense,V_dense);
0088    [viH,viV,indH_dense,indV,df] = <a href="../../../eidors/algorithms/n_polydorides/get_3d_meas.html" class="code" title="function [voltageH,voltageV,indH,indV,df] = get_3d_meas(elec,vtx,V,Ib,no_pl);">get_3d_meas</a>(elec_dense,vtx_dense,V_dense,Ib_dense,no_pl);
0089    dfv = df(1:2:end);
0090    vi = (viH); 
0091    <span class="comment">%sprintf('Measurement fields for iteration %d',i)</span>
0092    [v_f_dense] = <a href="../../../eidors/algorithms/n_polydorides/m_3d_fields.html" class="code" title="function [v_f] = m_3d_fields(vtx,el_no,m_ind,E,tol,gnd_ind,v_f);">m_3d_fields</a>(vtx_dense,el_no,indH_dense,E_dense,tol_for,gnd_ind_dense,v_f_dense);
0093 <span class="keyword">end</span>
0094     
0095     
0096 <span class="comment">%% DENSE MESH TO COARSE MESH HERE for scaler potentials</span>
0097 
0098 [V_coarse] = <a href="#_sub2" class="code" title="subfunction [V_coarse] = mapvd(V_dense,index_vtx,elec,vtx_coarse,vtx_dense);">mapvd</a>(V_dense,index_vtx,elec_dense,vtx_coarse,vtx_dense);
0099 
0100 [v_f_coarse] = <a href="#_sub3" class="code" title="subfunction [v_f_coarse] = mapvm(v_f_dense,index_vtx,indH_dense,vtx_coarse,vtx_dense);">mapvm</a>(v_f_dense,index_vtx,indH_dense,vtx_coarse,vtx_dense);
0101 
0102 [viH,viV,indH_coarse,indV,df_coarse] = <a href="../../../eidors/algorithms/n_polydorides/get_3d_meas.html" class="code" title="function [voltageH,voltageV,indH,indV,df] = get_3d_meas(elec,vtx,V,Ib,no_pl);">get_3d_meas</a>(elec_coarse,vtx_coarse,V_coarse,Ib_coarse,no_pl); <span class="comment">% for dfv_coarse in Jacobian calculation</span>
0103 
0104 dfv_coarse = df_coarse(1:2:end);
0105 
0106 [E_coarse,D_coarse,Ela_coarse,pp_coarse] = <a href="../../../eidors/algorithms/n_polydorides/fem_master_full.html" class="code" title="function [E,D,Ela,pp] = fem_master_full(vtx,simp,mat,gnd_ind,elec,zc,perm_sym);">fem_master_full</a>(vtx_coarse,simp_coarse,mat_ref_coarse,gnd_ind_coarse,elec_coarse,zc,perm_sym);  <span class="comment">% for D in Jacobian calculation</span>
0107 
0108 [J_coarse] = <a href="jacobian_3d_with_fields.html" class="code" title="function [J] = jacobian_3d_with_fields(V,Ela,D,I,elec,vtx,simp,gnd_ind,mat_ref,zc,v_f,df,tol,sym);">jacobian_3d_with_fields</a>(V_coarse,Ela_coarse,D_coarse,I_coarse,elec_coarse,vtx_coarse,simp_coarse,gnd_ind_coarse,sol_upd_coarse,zc,v_f_coarse,dfv_coarse,tol_for,perm_sym);
0109 
0110 sol_coarse = (J_coarse.'*J_coarse + tfac^2*RtR)\ (J_coarse.' * (voltage - vi));
0111 
0112 <span class="comment">% COARSE MESH TO DENSE MESH HERE for conductivity</span>
0113 
0114 sol_dense=sol_coarse(c2d_elem);
0115 
0116 sol_upd_dense = sol_upd_dense + sol_dense;
0117 sol_upd_coarse = sol_upd_coarse + sol_coarse;
0118 
0119 sol_coarse = sol_upd_coarse;
0120 sol_dense = sol_upd_dense;
0121 
0122 sol_array(:,iter)=sol_coarse;
0123 
0124 sprintf(<span class="string">'Error norm at iteration %d is %f'</span>,iter,norm(voltage - vi))
0125 
0126 <span class="keyword">end</span>
0127 
0128 
0129 <span class="comment">% create a data structure to return</span>
0130 img.name= <span class="string">'solved by inv_solve_trunc_iterative'</span>;
0131 img.elem_data = sol_array;
0132 img.fwd_model= M_dense;
0133 
0134 <a name="_sub1" href="#_subfunctions" class="code">function voltH = elec_volts( Vfwd, fwd_model)</a>
0135     p = <a href="../../../eidors/algorithms/n_polydorides/np_fwd_parameters.html" class="code" title="function param = np_fwd_parameters( fwd_model )">np_fwd_parameters</a>( fwd_model);
0136     Velec=Vfwd( p.n_node+(1:p.n_elec),:);
0137     voltH = zeros( p.n_meas, 1 );
0138     idx=0;
0139     <span class="keyword">for</span> i=1:p.n_stim
0140        meas_pat= fwd_model.stimulation(i).meas_pattern;
0141        n_meas  = size(meas_pat,1);
0142        voltH( idx+(1:n_meas) ) = meas_pat*Velec(:,i);
0143        idx= idx+ n_meas;
0144     <span class="keyword">end</span>
0145 
0146 <a name="_sub2" href="#_subfunctions" class="code">function [V_coarse] = mapvd(V_dense,index_vtx,elec,vtx_coarse,vtx_dense);</a>
0147 
0148 <span class="comment">% This function maps the scaler potential field</span>
0149 <span class="comment">% from the dense mesh to the coarse</span>
0150 <span class="comment">% mesh using verticies extraction.</span>
0151 
0152 <span class="keyword">for</span> j=1:size(elec,1);
0153 
0154     <span class="keyword">for</span> i=1:size(vtx_coarse,1);
0155 
0156         V_coarse(i,j)=V_dense((index_vtx(i,1)),j);
0157         
0158     <span class="keyword">end</span>
0159     
0160 <span class="keyword">end</span>
0161 
0162 V_coarse_elec=V_dense((size(vtx_dense,1)+1):(size(V_dense,1)),:);
0163 
0164 V_coarse=[V_coarse;V_coarse_elec];
0165 
0166 <span class="comment">% This function maps the scaler potential field</span>
0167 <span class="comment">% from the dense mesh to the coarse</span>
0168 <span class="comment">% mesh using verticies extraction.</span>
0169 <a name="_sub3" href="#_subfunctions" class="code">function [v_f_coarse] = mapvm(v_f_dense,index_vtx,indH_dense,vtx_coarse,vtx_dense);</a>
0170 
0171 
0172 <span class="keyword">for</span> j=1:size(indH_dense,1);
0173 
0174     <span class="keyword">for</span> i=1:size(vtx_coarse,1);
0175 
0176         v_f_coarse(i,j)=v_f_dense((index_vtx(i,1)),j);
0177         
0178     <span class="keyword">end</span>
0179     
0180 <span class="keyword">end</span>
0181 
0182 v_f_coarse_elec=v_f_dense((size(vtx_dense,1)+1):(size(v_f_dense,1)),:);
0183 
0184 v_f_coarse=[v_f_coarse;v_f_coarse_elec];</pre></div>
<hr><address>Generated on Tue 09-Aug-2011 11:38:31 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>