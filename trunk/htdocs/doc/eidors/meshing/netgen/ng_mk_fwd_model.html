<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ng_mk_fwd_model</title>
  <meta name="keywords" content="ng_mk_fwd_model">
  <meta name="description" content="NG_MK_FWD_MODEL: create a fwd_model object from a netgen vol file">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html?eidors/meshing/netgen/ng_mk_fwd_model.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html eidors --><!-- # meshing --><!-- menu.html netgen -->
<h1>ng_mk_fwd_model
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>NG_MK_FWD_MODEL: create a fwd_model object from a netgen vol file</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [fwd_mdl, mat_indices]=ng_mk_fwd_model( ng_vol_filename, centres,name, stim_pattern, z_contact, postprocmesh) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> NG_MK_FWD_MODEL: create a fwd_model object from a netgen vol file
 [fwd_mdl, mat_indices]= ...
      ng_mk_fwd_model( ng_vol_filename, centres, ...
                       name, stim_pattern, z_contact)

  ng_vol_filename:   filename output from netgen
  name:              name for object (if [] use ng_vol_filename)
  centres:           matrix of N x [x,y,z] electrode centres
                     centres can also be a Nx1 cell matrix of
                     functions which are 1 inside the electrode and 0 outside
  stim_pattern:      a stimulation pattern structure
                     empty ([]) if stim_pattern is not available
  z_contact:         vector or scalar electrode contact impedance

  fwd_mdl:           eidors format fwd_model
  mat_indices:       cell array of material indices from eidors</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/algorithms/a_adler/aa_calc_jacobian.html" class="code" title="function J= aa_calc_jacobian( fwd_model, img)">aa_calc_jacobian</a>	AA_CALC_JACOBIAN: J= aa_calc_jacobian( fwd_model, img)</li><li><a href="../../../eidors/algorithms/a_adler/aa_calc_system_mat.html" class="code" title="function s_mat= aa_calc_system_mat( fwd_model, img)">aa_calc_system_mat</a>	AA_CALC_SYSTEM_MAT: SS= aa_calc_system_mat( fwd_model, img)</li><li><a href="../../../eidors/algorithms/a_adler/aa_fwd_solve.html" class="code" title="function data =aa_fwd_solve(fwd_model, img)">aa_fwd_solve</a>	AA_FWD_SOLVE: data= aa_fwd_solve( fwd_model, img)</li><li><a href="../../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>	EIDORS_OBJ: 'constructor' to create a eidors structure</li><li><a href="ng_read_mesh.html" class="code" title="function[srf,vtx,fc,bc,simp,edg,mat_ind] = ng_read_mesh(filename)">ng_read_mesh</a>	[srf,vtx,fc,bc,simp,edg,mat_ind] = ng_read_mesh(filename)</li><li><a href="ng_tank_find_elec.html" class="code" title="function [elec,sels, electrodes] = ng_tank_find_elec(srf,vtx,fc,centres)">ng_tank_find_elec</a>	[elec,sels, electrodes] = ng_tank_find_elec(srf,vtx,fc,centres);</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>	NG_MAKE_CYL_MODELS: create cylindrical models using netgen</li><li><a href="ng_mk_ellip_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_ellip_models(ellip_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_ellip_models</a>	NG_MAKE_ELLIP_MODELS: create elliptical models using netgen</li><li><a href="ng_mk_extruded_model.html" class="code" title="function [fmdl,mat_idx] = ng_mk_extruded_model(shape, elec_pos, elec_shape,extra_ng_code)">ng_mk_extruded_model</a>	NG_MAKE_EXTRUDED_MODEL: create extruded models using netgen</li><li><a href="ng_mk_gen_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_gen_models(shape_str, elec_pos,  elec_shape, elec_obj);">ng_mk_gen_models</a>	NG_MAKE_ELLIP_MODELS: create elliptical models using netgen</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function fwd_mdl= construct_fwd_model(srf,vtx,simp,bc, name,</a></li><li><a href="#_sub2" class="code">function mat_idx= mk_mat_indices( mat_ind);</a></li><li><a href="#_sub3" class="code">function gnd_node=    find_centre_node(vtx);</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [fwd_mdl, mat_indices]= </a><span class="keyword">...</span>
0002              ng_mk_fwd_model( ng_vol_filename, centres, <span class="keyword">...</span>
0003                               name, stim_pattern, z_contact, postprocmesh)
0004 <span class="comment">% NG_MK_FWD_MODEL: create a fwd_model object from a netgen vol file</span>
0005 <span class="comment">% [fwd_mdl, mat_indices]= ...</span>
0006 <span class="comment">%      ng_mk_fwd_model( ng_vol_filename, centres, ...</span>
0007 <span class="comment">%                       name, stim_pattern, z_contact)</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%  ng_vol_filename:   filename output from netgen</span>
0010 <span class="comment">%  name:              name for object (if [] use ng_vol_filename)</span>
0011 <span class="comment">%  centres:           matrix of N x [x,y,z] electrode centres</span>
0012 <span class="comment">%                     centres can also be a Nx1 cell matrix of</span>
0013 <span class="comment">%                     functions which are 1 inside the electrode and 0 outside</span>
0014 <span class="comment">%  stim_pattern:      a stimulation pattern structure</span>
0015 <span class="comment">%                     empty ([]) if stim_pattern is not available</span>
0016 <span class="comment">%  z_contact:         vector or scalar electrode contact impedance</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%  fwd_mdl:           eidors format fwd_model</span>
0019 <span class="comment">%  mat_indices:       cell array of material indices from eidors</span>
0020  
0021 <span class="comment">% (C) 2006 Andy Adler. License: GPL version 2 or version 3</span>
0022 <span class="comment">% $Id$</span>
0023 
0024 <span class="keyword">if</span> isempty(name); 
0025    name = [<span class="string">'MDL from'</span>, ng_vol_filename];
0026 <span class="keyword">end</span>
0027 
0028 <span class="keyword">if</span> nargin&lt;5
0029    z_contact=0.01; <span class="comment">% singular if z_contact=0</span>
0030 <span class="keyword">end</span>
0031 
0032 <span class="comment">% Model Geometry</span>
0033 [srf,vtx,fc,bc,simp,edg,mat_ind] = <a href="ng_read_mesh.html" class="code" title="function[srf,vtx,fc,bc,simp,edg,mat_ind] = ng_read_mesh(filename)">ng_read_mesh</a>(ng_vol_filename);
0034 <span class="keyword">if</span> nargin&gt;=6
0035     N_elec = max(size(centres));
0036     [srf,vtx,fc,bc,simp,edg,mat_ind] = feval(postprocmesh,<span class="keyword">...</span>
0037         srf,vtx,fc,bc,simp,edg,mat_ind, N_elec);
0038 <span class="keyword">end</span>
0039 fwd_mdl= <a href="#_sub1" class="code" title="subfunction fwd_mdl= construct_fwd_model(srf,vtx,simp,bc, name, ">construct_fwd_model</a>(srf,vtx,simp,bc, name, <span class="keyword">...</span>
0040                              stim_pattern, centres, z_contact,fc);
0041 mat_indices= <a href="#_sub2" class="code" title="subfunction mat_idx= mk_mat_indices( mat_ind);">mk_mat_indices</a>( mat_ind);
0042 
0043 <span class="comment">% build fwd_model structure</span>
0044 <a name="_sub1" href="#_subfunctions" class="code">function fwd_mdl= construct_fwd_model(srf,vtx,simp,bc, name, </a><span class="keyword">...</span>
0045                        stim_pattern, centres, z_contact,fc)
0046 mdl.nodes    = vtx;
0047 mdl.elems    = simp;
0048 mdl.boundary = srf;
0049 mdl.boundary_numbers=fc;    
0050 mdl.gnd_node=    <a href="#_sub3" class="code" title="subfunction gnd_node=    find_centre_node(vtx);">find_centre_node</a>(vtx);
0051 mdl.np_fwd_solve.perm_sym =     <span class="string">'{n}'</span>;
0052 mdl.name = name;
0053 
0054 <span class="comment">% Model Stimulation</span>
0055 <span class="keyword">if</span> ~isempty(stim_pattern)
0056    mdl.stimulation= stim_pattern;
0057 <span class="keyword">end</span>
0058 
0059 nelec= size(centres,1);
0060 <span class="keyword">if</span> nelec&gt;0
0061    <span class="comment">% Electrodes</span>
0062    [elec,sels,electrodes] = <a href="ng_tank_find_elec.html" class="code" title="function [elec,sels, electrodes] = ng_tank_find_elec(srf,vtx,fc,centres)">ng_tank_find_elec</a>(srf,vtx,bc,centres);
0063    <span class="keyword">if</span> size(elec,1) ~= nelec
0064       error(<span class="string">'Failed to find all the electrodes'</span>)
0065    <span class="keyword">end</span>
0066 
0067    <span class="comment">% set the z_contact</span>
0068    z_contact= z_contact.*ones(nelec,1);
0069    <span class="keyword">for</span> i=1:nelec
0070       electrodes(i).z_contact= z_contact(i);
0071    <span class="keyword">end</span>
0072 
0073    mdl.electrode =     electrodes;
0074 <span class="keyword">end</span>
0075 
0076 mdl.solve=      @<a href="../../../eidors/algorithms/a_adler/aa_fwd_solve.html" class="code" title="function data =aa_fwd_solve(fwd_model, img)">aa_fwd_solve</a>;
0077 mdl.jacobian=   @<a href="../../../eidors/algorithms/a_adler/aa_calc_jacobian.html" class="code" title="function J= aa_calc_jacobian( fwd_model, img)">aa_calc_jacobian</a>;
0078 mdl.system_mat= @<a href="../../../eidors/algorithms/a_adler/aa_calc_system_mat.html" class="code" title="function s_mat= aa_calc_system_mat( fwd_model, img)">aa_calc_system_mat</a>;
0079 
0080 fwd_mdl= <a href="../../../eidors/eidors_obj.html" class="code" title="function obj_id= eidors_obj(type,name, varargin );">eidors_obj</a>(<span class="string">'fwd_model'</span>, mdl);
0081 
0082 <span class="comment">% Output cell array of indices into each material type</span>
0083 <span class="comment">%   array order is the order of the specified material,</span>
0084 <span class="comment">%   except that the largest material (background) is placed</span>
0085 <span class="comment">%   first.</span>
0086 <a name="_sub2" href="#_subfunctions" class="code">function mat_idx= mk_mat_indices( mat_ind);</a>
0087   <span class="comment">% find length of mat_indices</span>
0088   <span class="comment">% test example: mat_ind=[10 12 14 14 12 12 14 12];</span>
0089 
0090   mat_indices = unique( mat_ind );
0091   <span class="keyword">for</span> i= 1:length(mat_indices);
0092      mat_idx{i}= find(mat_ind == mat_indices(i));
0093      mat_idx_l(i) = length( mat_idx{i} );
0094   <span class="keyword">end</span>
0095   <span class="comment">% put the largest material first</span>
0096   [jnk, max_l] = max(mat_idx_l);
0097   new_idx = 1:length(mat_indices); new_idx(max_l) = [];
0098   [mat_idx{:}] = mat_idx{[max_l, new_idx]};
0099 
0100 
0101 <a name="_sub3" href="#_subfunctions" class="code">function gnd_node=    find_centre_node(vtx);</a>
0102   <span class="comment">%distance from zero</span>
0103   d = sum( vtx.^2, 2);
0104   [jnk,gnd_node] = min(d);
0105   gnd_node= gnd_node(1);</pre></div>
<hr><address>Generated on Tue 09-Aug-2011 11:38:31 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>