#! /bin/bash

echo "last tested: 2017-04-18 with Ubuntu xenial 16.04.2 LTS"
echo "run $(date)"


SFDL=https://sourceforge.net/projects

# versions to install
# TCL
TCLVER=8.5.8
# Tix
TIXVER=8.4.3
# Togl
TOGLVER=1.7
#NetGen version
NGVER=$(basename $0)
NGVER=${NGVER##*-}
echo "netgen install version: $NGVER"
# local install
SRCDIR=${SRCDIR:-~/netgen-${NGVER}-src}
INSTDIR=${INSTDIR:-~/netgen-${NGVER}}



# TK version should probably match TCL version
TKVER=${TCLVER}

CFLAGS="$CFLAGS -I${INSTDIR}/include"
CPPFLAGS="$CPPFLAGS ${CFLAGS}"

function err() {
  echo "$(basename $0) ERROR: $1"
  exit 1
}

set -e
set -x
# make working directories if they don't exist
mkdir -p ${SRCDIR}
mkdir -p ${INSTDIR}

# get files
cd ${SRCDIR}
wget ${SFDL}/tcl/files/tcl${TCLVER}-src.tar.gz
wget ${SFDL}/tcl/files/tk${TKVER}-src.tar.gz
wget ${SFDL}/tix/files/tix/${TIXVER}/Tix${TIXVER}-src.tar.gz
wget ${SFDL}/togl/files/Togl/${TOGLVER}/Togl-${TOGLVER}.tar.gz
wget ${SFDL}/netgen-mesher/files/netgen-mesher/${NGVER}/netgen-${NGVER}.tar.gz

# unpack files
tar zxvf tcl${TCLVER}-src.tar.gz > /dev/null
tar zxvf  tk${TKVER}-src.tar.gz > /dev/null
tar zxvf  Tix${TIXVER}-src.tar.gz > /dev/null
tar zxvf  Togl-${TOGLVER}.tar.gz > /dev/null
tar zxvf  netgen-${NGVER}.tar.gz > /dev/null

# build tcl
cd ${SRCDIR}/tcl${TCLVER}/unix
./configure --prefix=${INSTDIR} --enable-threads --enable-shared --enable-64bit
make
make install

# build tk
cd ${SRCDIR}/tk${TKVER}/unix
./configure --prefix=${INSTDIR} --with-tcl=${INSTDIR}/lib --enable-threads --enable-shared --enable-64bit
make
make install

# build tix
cd ${SRCDIR}/Tix${TIXVER}
./configure --prefix=${INSTDIR} --with-tcl=${INSTDIR}/lib --with-tk=${INSTDIR}/lib --enable-threads --enable-shared --enable-64bit
make
make install


# build Togl
cd ${SRCDIR}/Togl-${TOGLVER}
./configure --prefix=${INSTDIR} --with-tcl=${INSTDIR}/lib --with-tk=${INSTDIR}/lib  --enable-threads --enable-shared --enable-64bit
make
make install

# TODO is this necessary?
ln -s ${INSTDIR}/lib/Togl${TOGLVER}/libTogl${TOGLVER}.so ${INSTDIR}/lib/libTogl${TOGLVER}.so

# build NetGen
cd ${SRCDIR}/netgen-${NGVER}
CPPFLAGS=${CPPFLAGS} CFLAGS=${CFLAGS} ./configure --prefix=${INSTDIR} --with-tcl=${INSTDIR}/lib --with-tk=${INSTDIR}/lib --with-togl=${INSTDIR}/lib --with-tclinclude=${INSTDIR}/include
make
make install

# clean up
cd
rm -rf "${SRCDIR}/tcl${TCLVER}"
rm -rf "${SRCDIR}/tk${TKVER}"
rm -rf "${SRCDIR}/Tix${TIXVER}"
rm -rf "${SRCDIR}/Togl-${TOGLVER}"
rm -rf "${SRCDIR}/netgen-${NGVER}"
cp "$0" "${SRCDIR}"

# fix path issues
mv ${INSTDIR}/bin/netgen ${INSTDIR}/bin/netgen-exec
echo "#! /bin/sh
D=${INSTDIR}/bin
L=${INSTDIR}/lib
LD_LIBRARY_PATH=\$L NETGENDIR=\$D \$D/netgen-exec \$*
" > ${INSTDIR}/bin/netgen
chmod +x ${INSTDIR}/bin/netgen

echo "completed $(date)"
echo "run netgen with '${INSTDIR}/bin/netgen'"

